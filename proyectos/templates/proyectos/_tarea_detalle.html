{# templates/proyectos/_tarea_detalle.html #}
<style>
  .tarea-det { display:grid; gap:10px; }
  .tarea-det .row { display:grid; grid-template-columns: 180px 1fr; gap:10px; align-items:start; }
  .tarea-det .lbl { font-weight:700; color:#334155; }
  .tarea-det .val { color:#0f172a; }
  .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
  .chip { background:#f1f5f9; color:#334155; border-radius:999px; padding:2px 10px; font-weight:600; font-size:12px; }
  .chip-ok { background:#e8f5e9; color:#1b5e20; }
  .chip-warn { background:#fff8e1; color:#8d6e00; }
  .chip-danger { background:#ffebee; color:#b71c1c; }
  .chip-critical { background:#e8f5e9; color:#14532d; font-weight:700; }
  .muted { color:#64748b; }
  .divider { height:1px; background:#e5e7eb; margin:8px 0; }
</style>

{% if request.GET.context == 'perfil' %}
  <div class="tarea-det">
    <div class="row"><div class="lbl">Tarea</div><div class="val">{{ t.titulo }}</div></div>

    {% if t.descripcion %}
      <div class="row"><div class="lbl">Descripción</div><div class="val">{{ t.descripcion|linebreaksbr }}</div></div>
    {% endif %}

    {% if t.proyecto %}
      <div class="row"><div class="lbl">Proyecto</div><div class="val">{{ t.proyecto.nombre }}</div></div>
    {% endif %}

    <div class="row"><div class="lbl">Fecha de vencimiento</div><div class="val">{% if t.vence_el %}{{ t.vence_el|date:"d/m/Y" }}{% else %}—{% endif %}</div></div>

    <div class="row">
      <div class="lbl">Prioridad</div>
      <div class="val">
        <div class="chips">
          {% with p=t.prioridad %}
            {% if p %}
              {% with lbl=t.get_prioridad_display|default:"Prioridad" %}
                {% if p|add:0 == 5 %}
                  <span class="chip chip-critical">{{ lbl }}</span>
                {% elif p|add:0 >= 4 %}
                  <span class="chip chip-danger">{{ lbl }}</span>
                {% elif p|add:0 == 3 %}
                  <span class="chip chip-warn">{{ lbl }}</span>
                {% else %}
                  <span class="chip chip-ok">{{ lbl }}</span>
                {% endif %}
              {% endwith %}
            {% else %}
              <span class="chip">Sin prioridad</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="tarea-det">
    <div class="row"><div class="lbl">Título</div><div class="val">{{ t.titulo }}</div></div>

    {% if t.descripcion %}
      <div class="row"><div class="lbl">Descripción</div><div class="val">{{ t.descripcion|linebreaksbr }}</div></div>
    {% endif %}

    <div class="row"><div class="lbl">Proyecto</div><div class="val">{{ t.proyecto.nombre }}</div></div>
    <div class="row"><div class="lbl">Asignado a</div><div class="val">{% if t.asignado_a %}{{ t.asignado_a.get_full_name|default:t.asignado_a.username }}{% else %}—{% endif %}</div></div>
    <div class="row"><div class="lbl">Estado</div><div class="val chips"><span class="chip">{{ t.get_estado_display }}</span></div></div>
    <div class="row"><div class="lbl">Vence el</div><div class="val">{% if t.vence_el %}{{ t.vence_el|date:"d/m/Y" }}{% else %}—{% endif %}</div></div>

    <div class="row">
      <div class="lbl">Prioridad</div>
      <div class="val">
        <div class="chips">
          {% with p=t.prioridad %}
            {% if p %}
              {% with lbl=t.get_prioridad_display|default:"Prioridad" %}
                {% if p|add:0 == 5 %}
                  <span class="chip chip-critical">{{ lbl }}</span>
                {% elif p|add:0 >= 4 %}
                  <span class="chip chip-danger">{{ lbl }}</span>
                {% elif p|add:0 == 3 %}
                  <span class="chip chip-warn">{{ lbl }}</span>
                {% else %}
                  <span class="chip chip-ok">{{ lbl }}</span>
                {% endif %}
              {% endwith %}
            {% else %}
              <span class="chip">Sin prioridad</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    {% if t.estimacion_horas %}
      <div class="row"><div class="lbl">Estimación</div><div class="val">{{ t.estimacion_horas }} h</div></div>
    {% endif %}

    <div class="divider"></div>
    <div class="muted">Creada: {{ t.creado_en|date:"d/m/Y H:i" }} · Actualizada: {{ t.actualizado_en|date:"d/m/Y H:i" }}</div>
  </div>
{% endif %}

{# ==================== CONVERSACIÓN / CHAT ==================== #}
<style>
  .chat-wrap { margin-top: 14px; }
  .chat-title { font-weight:700; color:#1f2937; margin: 8px 0; }

  /* FIX: flex column para que .stick-bottom funcione en cualquier modal */
  .chat-box {
    border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb;
    height: 280px;
    overflow-y: auto;
    padding:10px;

    display:flex;
    flex-direction:column;
  }

  .chat-list {
    list-style:none; margin:0; padding:0;
    display:flex; flex-direction:column; gap:10px;
  }
  .chat-list.stick-bottom { margin-top:auto; }

  .msg { display:flex; }
  .msg.me    { justify-content:flex-end; }
  .msg.other { justify-content:flex-start; }

  .bubble {
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; max-width:70%;
    box-shadow:0 1px 2px rgba(0,0,0,.03);
  }
  .msg.me .bubble { background:#eef2ff; border-color:#dbeafe; }

  .meta { font-size:12px; color:#6b7280; margin-bottom:4px; }

  .composer { display:flex; gap:8px; margin-top:8px; }
  .composer textarea {
    flex:1; resize:vertical; min-height:40px; max-height:160px;
    border:1px solid #e5e7eb; border-radius:8px; padding:8px; background:#fff;
  }
  .composer button {
    border:none; background:#2563eb; color:#fff; border-radius:8px; padding:0 14px; font-weight:700; cursor:pointer;
  }
  .composer button:hover { background:#1e40af; }

  .muted { color:#6b7280; }
</style>

<div class="chat-wrap">
  <div class="chat-title">Conversación</div>

  <div id="chatBox" class="chat-box">
    <ul id="chatList" class="chat-list">
      {% if mensajes %}
        {% for m in mensajes %}
          <li class="msg {% if m.autor_id == request.user.id %}me{% else %}other{% endif %}">
            <div class="bubble">
              <div class="meta">
                <strong>{{ m.autor.get_full_name|default:m.autor.username }}</strong>
                <span>· {{ m.creado_en|date:"d/m/Y H:i" }}</span>
              </div>
              <div class="text">{{ m.cuerpo|linebreaksbr }}</div>
            </div>
          </li>
        {% endfor %}
      {% else %}
        <li class="muted">Aún no hay mensajes.</li>
      {% endif %}
    </ul>
  </div>

  {% if puede_chatear %}
    <form id="chatForm" class="composer" action="{% url 'proyectos:tarea_chat_enviar' t.id %}" method="post">
      {% csrf_token %}
      <textarea name="mensaje" placeholder="Escribí un mensaje…"></textarea>
      <button type="submit">Enviar</button>
    </form>
  {% else %}
    <p class="muted" style="margin-top:6px">No tenés permisos para participar en esta conversación.</p>
  {% endif %}
</div>

<script>
(function(){
  const form = document.getElementById('chatForm');
  const list = document.getElementById('chatList');
  const box  = document.getElementById('chatBox');

  function scrollBottom(){ if(box) box.scrollTop = box.scrollHeight; }
  function updateStick(){
    if (!box || !list) return;
    list.classList.toggle('stick-bottom', list.scrollHeight > box.clientHeight);
  }

  updateStick();
  scrollBottom();

  if (!form) return;

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const data = new FormData(form);
    const btn  = form.querySelector('button[type=submit]');
    btn.disabled = true;

    try{
      const r = await fetch(form.action, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        body: data
      });
      const json = await r.json();

      if (json.ok){
        const tmp = document.createElement('div');
        tmp.innerHTML = json.html || '';
        let li = tmp.firstElementChild;

        if(!li){
          li = document.createElement('li');
          li.className = 'msg me';
          li.innerHTML = '<div class="bubble"><div class="meta"><strong>Yo</strong> · ahora</div><div class="text"></div></div>';
          li.querySelector('.text').textContent = (data.get('mensaje')||'').trim();
        }

        list.appendChild(li);
        form.reset();
        updateStick();
        scrollBottom();
      }else{
        alert(json.error || 'No se pudo enviar el mensaje.');
      }
    }catch(err){
      console.error(err);
      alert('Error de red.');
    }finally{
      btn.disabled = false;
    }
  });

  window.addEventListener('resize', updateStick);
})();
</script>
