{# templates/proyectos/dashboard.html #}
{% extends "_base.html" %}
{% block title %}Proyectos{% endblock %}

{% block content %}
  {# Tarjetas de navegación #}
  {% include "proyectos/_cards_nav.html" %}

  {# Botón NUEVO arriba de la tabla #}
  {% if perms.proyectos.can_manage_proyectos %}
    <div style="display:flex;justify-content:flex-end;margin:10px 0 6px;">
      <button type="button"
              id="btnNuevoProyecto"
              class="btn btn-primary">
        Nuevo
      </button>
    </div>
  {% endif %}

  {# ============== VENCIMIENTOS agrupados por proyecto (TODAS las tareas con fecha) ============== #}
  {% if current_tab == "vencimientos" %}
    <style>
      .venc-group{ margin:18px 0 10px; }
      .venc-group h3{ margin:0 0 8px; font-size:16px; display:flex; gap:10px; align-items:center; }
      .venc-chip{ background:#eef2ff; color:#1e40af; border-radius:999px; padding:4px 8px; font-weight:600; font-size:12px; }
      .venc-table{ width:100%; border-collapse:collapse; }
      .venc-table th, .venc-table td{ padding:10px 12px; border-top:1px solid #e5e7eb; }
      .venc-table th{ text-align:left; font-weight:700; color:#334155; background:#f8fafc; }
      .venc-table tr:hover td{ background:#fbfdff; }
      .btn-sm{ display:inline-block; padding:6px 10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer }
      .btn-sm:hover{ background:#f8fafc; }

      /* ===== Modal genérico para tareas / proyectos ===== */
      .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1100; }
      .modal-overlay.open{ display:flex; }
      .modal{ width:clamp(560px, 64vw, 720px); max-width:720px; background:#fff; border-radius:12px; box-shadow:0 10px 35px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; }
      .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; }
      .modal-title{ margin:0; font-size:18px; font-weight:700; color:#1e293b; }
      .modal-body{ padding:16px 18px; max-height:72vh; overflow:auto; }
      .btn-close{ border:none; background:transparent; font-size:22px; line-height:1; cursor:pointer; color:#666; }
    </style>

    {% if vencimientos_grouped and vencimientos_grouped|length > 0 %}
      {% for g in vencimientos_grouped %}
        <div class="venc-group">
          <h3>
            {{ g.proyecto.nombre }}
            <span class="venc-chip">Cierre: {{ g.fecha_cierre|date:"d/m/Y"|default:"—" }}</span>
          </h3>

          <table class="venc-table">
            <thead>
              <tr>
                <th style="width:36%">Tarea</th>
                <th style="width:18%">Encargado</th>
                <th style="width:14%">Vence</th>
                <th style="width:18%">Responsable</th>
                <th style="width:14%"></th>
              </tr>
            </thead>
            <tbody>
              {% for t in g.tareas %}
                <tr>
                  <td>{{ t.titulo }}</td>
                  <td>{% if t.asignado_a %}{{ t.asignado_a.get_full_name|default:t.asignado_a.username }}{% else %}—{% endif %}</td>
                  <td>{{ t.vence_el|date:"d/m/Y" }}</td>
                  <td>{% if g.proyecto.responsable %}{{ g.proyecto.responsable.get_full_name|default:g.proyecto.responsable.username }}{% else %}—{% endif %}</td>
                  <td>
                    <button
                      type="button"
                      class="btn-sm js-open-tarea"
                      data-url="{% url 'proyectos:tarea_detalle_modal' t.id %}"
                      data-title="Tarea: {{ t.titulo|escapejs }}">
                      Ver
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p style="color:#64748b">No hay tareas con fecha de vencimiento.</p>
    {% endif %}
    
  {% else %}
    {# ============== TODOS LOS PROYECTOS – VISTA KANBAN DE CARDS AGRUPADAS POR ESTADO ============== #}
    <style>
      .proj-section{
        margin-top:18px;
      }
      .proj-section-header{
        display:flex;
        align-items:center;
        gap:8px;
        margin:0 0 6px;
      }
      .proj-section-title{
        margin:0;
        font-size:15px;
        font-weight:700;
        color:#111827;
      }
      .proj-section-pill{
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:.04em;
        padding:2px 7px;
        border-radius:999px;
        background:#e5e7eb;
        color:#4b5563;
      }
      .proj-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
        gap:14px;
        margin-top:8px;
        padding:4px 2px 6px;
        border-radius:10px;
        transition:background .15s ease, box-shadow .15s ease;
      }
      /* Resaltado cuando se arrastra encima */
      .proj-grid.is-drop-target{
        background:#eff6ff;
        box-shadow:0 0 0 1px #bfdbfe inset;
      }
      .proj-card{
        border-radius:12px;
        border:1px solid #e5e7eb;
        background:#ffffff;
        padding:14px 15px 12px;
        box-shadow:0 1px 3px rgba(15,23,42,.06);
        display:flex;
        flex-direction:column;
        gap:6px;
        transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
        cursor:grab;
      }
      .proj-card:active{ cursor:grabbing; }
      .proj-card:hover{
        transform:translateY(-2px);
        box-shadow:0 10px 20px rgba(15,23,42,.08);
        border-color:#cbd5f5;
        background:#f9fafb;
      }
      .proj-name{
        font-weight:700;
        font-size:15px;
        color:#0f172a;
        margin-bottom:2px;
      }
      .proj-desc{
        font-size:13px;
        color:#6b7280;
        min-height:32px;
      }
      .proj-meta{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:12px;
        color:#6b7280;
        margin-top:4px;
      }
      .proj-resp{
        max-width:60%;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .proj-chip-estado{
        font-size:11px;
        font-weight:600;
        padding:2px 8px;
        border-radius:999px;
        background:#e5e7eb;
        color:#374151;
        text-transform:uppercase;
        letter-spacing:.04em;
      }
      .proj-actions{
        margin-top:8px;
        display:flex;
        justify-content:flex-end;
      }
      .proj-btn-ver{
        border-radius:999px;
        border:1px solid #2563eb;
        background:#2563eb;
        color:#ffffff !important;
        font-size:12px;
        font-weight:600;
        padding:6px 16px;
        text-decoration:none;
        cursor:pointer;
        transition:background .12s ease, border-color .12s ease, transform .08s ease;
      }
      .proj-btn-ver:hover{
        background:#1d4ed8;
        border-color:#1d4ed8;
        transform:translateY(-1px);
        color:#ffffff !important;
      }
    </style>

    {% if items %}
      {% with items|dictsort:"estado" as items_sorted %}
        {% regroup items_sorted by estado as proyectos_grouped %}

        {% for group in proyectos_grouped %}
          <section class="proj-section" data-estado-proy="{{ group.grouper }}">
            <div class="proj-section-header">
              <h3 class="proj-section-title">
                {% with group.list.0 as p0 %}
                  {{ p0.get_estado_display|default:"Sin estado" }}
                {% endwith %}
              </h3>
              <span class="proj-section-pill">
                {{ group.list|length }} proyecto{{ group.list|length|pluralize:"s" }}
              </span>
            </div>

            <div class="proj-grid"
                 data-drop-estado="{{ group.grouper }}"
                 ondragover="projAllowDrop(event)"
                 ondragenter="projDragEnter(event)"
                 ondragleave="projDragLeave(event)"
                 ondrop="projDropOnEstado(event)">
              {% for p in group.list %}
                <article class="proj-card"
                         draggable="true"
                         data-proyecto="{{ p.id }}"
                         ondragstart="projDrag(event)"
                         ondragend="projDragEnd(event)">
                  <div class="proj-name">{{ p.nombre }}</div>
                  <div class="proj-desc">
                    {{ p.descripcion|default:"Sin descripción"|truncatechars:120 }}
                  </div>

                  <div class="proj-meta">
                    <span class="proj-resp">
                      {% if p.responsable %}
                        {{ p.responsable.get_full_name|default:p.responsable.username }}
                      {% else %}Sin responsable{% endif %}
                    </span>
                    <span class="proj-chip-estado">
                      {{ p.get_estado_display|default:"—" }}
                    </span>
                  </div>

                  <div class="proj-actions">
                    <a href="{% url 'proyectos:detalle' p.id %}" class="proj-btn-ver">
                      Ver proyecto →
                    </a>
                  </div>
                </article>
              {% endfor %}
            </div>
          </section>
        {% endfor %}
      {% endwith %}
    {% else %}
      <p style="padding:10px;color:#666">No hay proyectos en esta sección.</p>
    {% endif %}
  {% endif %}


  {% if perms.proyectos.can_manage_proyectos %}
    <div id="modalProyecto" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalProyectoTitle">
        <div class="modal-header">
          <h3 id="modalProyectoTitle" class="modal-title">Nuevo proyecto</h3>
          <button type="button" class="btn-close" id="btnCerrarModalProyecto" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div id="modalProyectoContainer">
            <p style="margin:0;color:#666">Cargando formulario…</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# ===== Modal GENÉRICO para ver/editar tareas desde el dashboard ===== #}
  <div id="modalGeneral" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalGeneralTitle">
      <div class="modal-header">
        <h3 id="modalGeneralTitle" class="modal-title" style="margin:0">Detalle de tarea</h3>
        <button type="button" class="btn-close" id="btnCloseGeneral" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div id="modalGeneralContainer"><p style="margin:0;color:#666">Cargando…</p></div>
      </div>
    </div>
  </div>

  {# ===================== SCRIPTS embebidos ===================== #}
  <script>
    (function(){
      // URLs desde Django
      const NUEVO_PROY_URL = "{% url 'proyectos:nuevo' %}";
      const URL_CAMBIAR_ESTADO = "{% url 'proyectos:proyecto_cambiar_estado' 0 %}";

      const $ = (sel, ctx=document) => ctx.querySelector(sel);

      // ----- helper CSRF para drag & drop -----
      function getCookie(name){
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }

      // ----- Modal general de tareas -----
      const modalGeneral = $("#modalGeneral");
      const modalGeneralTitle = $("#modalGeneralTitle");
      const modalGeneralContainer = $("#modalGeneralContainer");
      const btnCloseGeneral = $("#btnCloseGeneral");

      function attachChatHandlers(){
        const form = $("#chatForm", modalGeneralContainer);
        const list = $("#chatList", modalGeneralContainer);
        const box  = $("#chatBox",  modalGeneralContainer);
        if (!form) return;

        const scrollBottom = () => { if (box) box.scrollTop = box.scrollHeight; };
        scrollBottom();

        form.addEventListener("submit", async function(e){
          e.preventDefault();
          const data = new FormData(form);
          const btn  = form.querySelector('button[type=submit]');
          btn.disabled = true;
          try{
            const r = await fetch(form.action, {
              method: "POST",
              headers: { "X-Requested-With": "XMLHttpRequest" },
              body: data
            });
            const json = await r.json();
            if (json.ok){
              const tmp = document.createElement("div");
              tmp.innerHTML = json.html || "";
              let li = tmp.firstElementChild;
              if (!li){
                li = document.createElement("li");
                li.className = "msg me";
                li.innerHTML = '<div class="bubble"><div class="meta"><strong>Yo</strong> · ahora</div><div class="text"></div></div>';
                li.querySelector(".text").textContent = data.get("mensaje") || "";
              }
              list.appendChild(li);
              form.reset();
              scrollBottom();
            } else {
              alert(json.error || "No se pudo enviar el mensaje.");
            }
          } catch(err){
            console.error(err);
            alert("Error de red.");
          } finally {
            btn.disabled = false;
          }
        });
      }

      function openGeneral(url, title){
        modalGeneral.classList.add("open");
        modalGeneral.setAttribute("aria-hidden","false");
        modalGeneralTitle.textContent = title || "Detalle";
        modalGeneralContainer.innerHTML = '<p style="margin:0;color:#666">Cargando…</p>';
        const bust = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        fetch(bust, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then(r => r.text())
          .then(html => { modalGeneralContainer.innerHTML = html; attachChatHandlers(); })
          .catch(() => { modalGeneralContainer.innerHTML = '<p style="color:#a00">No se pudo cargar el contenido.</p>'; });
      }
      function closeGeneral(){
        modalGeneral.classList.remove("open");
        modalGeneral.setAttribute("aria-hidden","true");
      }
      if (btnCloseGeneral) btnCloseGeneral.addEventListener("click", closeGeneral);
      if (modalGeneral) modalGeneral.addEventListener("click", e => { if (e.target === modalGeneral) closeGeneral(); });
      document.addEventListener("keydown", e => { if (e.key === "Escape") closeGeneral(); });

      // Delegación para botones "Ver" (tareas)
      document.addEventListener("click", function(e){
        const btn = e.target.closest(".js-open-tarea");
        if (!btn) return;
        e.preventDefault();
        openGeneral(btn.dataset.url, btn.dataset.title);
      });

      // ----- Modal "Nuevo proyecto" -----
      const modalProyecto = $("#modalProyecto");
      const modalProyectoContainer = $("#modalProyectoContainer");
      const btnCerrarModalProyecto = $("#btnCerrarModalProyecto");
      const btnNuevoProyecto = $("#btnNuevoProyecto");

      function openNuevoProyecto(){
        if (!modalProyecto) return;
        modalProyecto.classList.add("open");
        modalProyecto.setAttribute("aria-hidden","false");
        modalProyectoContainer.innerHTML = '<p style="margin:0;color:#666">Cargando formulario…</p>';
        fetch(NUEVO_PROY_URL, { headers: { "X-Requested-With": "XMLHttpRequest" }, cache: "no-store" })
          .then(r => r.text())
          .then(html => { modalProyectoContainer.innerHTML = html; attachProyectoFormHandlers(); })
          .catch(() => { modalProyectoContainer.innerHTML = '<p style="color:#a00">No se pudo cargar el formulario.</p>'; });
      }
      function closeNuevoProyecto(){
        if (!modalProyecto) return;
        modalProyecto.classList.remove("open");
        modalProyecto.setAttribute("aria-hidden","true");
      }
      if (btnNuevoProyecto) btnNuevoProyecto.addEventListener("click", openNuevoProyecto);
      if (btnCerrarModalProyecto) btnCerrarModalProyecto.addEventListener("click", closeNuevoProyecto);
      if (modalProyecto) modalProyecto.addEventListener("click", e => { if (e.target === modalProyecto) closeNuevoProyecto(); });
      document.addEventListener("keydown", e => { if (e.key === "Escape") closeNuevoProyecto(); });

      // Manejo submit AJAX del form de proyecto
      function attachProyectoFormHandlers(){
        const form = $("#formProyecto", modalProyectoContainer);
        const btnCancel = $("#btnCancelarProyecto", modalProyectoContainer);
        if (btnCancel) btnCancel.addEventListener("click", closeNuevoProyecto);
        if (!form) return;

        // ⬅️ Fallback: si el partial vino sin action, forzar la URL correcta
        if (!form.getAttribute('action') || form.getAttribute('action') === '') {
          form.setAttribute('action', NUEVO_PROY_URL);
        }

        form.addEventListener("submit", function(e){
          e.preventDefault();
          const formData = new FormData(form);

          // Enviamos como AJAX SIEMPRE:
          formData.set('ajax', '1');

          const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
          fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
            body: formData
          })
          .then(async (r) => {
            const text = await r.text();
            let data = null;
            try { data = JSON.parse(text); } catch (_) {}
            if (data && data.ok) {
              closeNuevoProyecto();
              if (data.redirect) window.location.href = data.redirect;
              else window.location.reload();
              return;
            }
            if (data && data.html) { modalProyectoContainer.innerHTML = data.html; attachProyectoFormHandlers(); return; }
            if (!data && text.trim().startsWith('<')) { modalProyectoContainer.innerHTML = text; attachProyectoFormHandlers(); return; }
            throw new Error('Respuesta inválida del servidor');
          })
          .catch(() => alert('Error de red al guardar.'));
        });
      }

      // ===== DRAG & DROP DE PROYECTOS (KANBAN) =====
            // ===== DRAG & DROP DE PROYECTOS (KANBAN) =====
      let draggedProyectoId = null;

      // Actualiza el texto "X proyectos" de la sección
      function updateSectionCount(section){
        if (!section) return;
        const grid = section.querySelector('.proj-grid');
        const pill = section.querySelector('.proj-section-pill');
        if (!grid || !pill) return;
        const n = grid.querySelectorAll('.proj-card').length;
        pill.textContent = `${n} proyecto${n === 1 ? '' : 's'}`;
      }

      // Actualiza el chip de estado dentro de la card
      function updateCardEstadoChip(card, targetSection){
        const chip  = card.querySelector('.proj-chip-estado');
        const title = targetSection?.querySelector('.proj-section-title');
        if (chip && title){
          // El CSS ya tiene text-transform: uppercase, así que con el título alcanza
          chip.textContent = title.textContent.trim();
        }
      }

      window.projDrag = function(ev){
        const card = ev.currentTarget;
        draggedProyectoId = card.dataset.proyecto;
        ev.dataTransfer.effectAllowed = 'move';
      };

      window.projDragEnd = function(){
        draggedProyectoId = null;
        document.querySelectorAll('.proj-grid.is-drop-target')
          .forEach(el => el.classList.remove('is-drop-target'));
      };

      window.projAllowDrop = function(ev){
        ev.preventDefault();
      };

      window.projDragEnter = function(ev){
        const grid = ev.currentTarget.closest('.proj-grid');
        if (grid) grid.classList.add('is-drop-target');
      };

      window.projDragLeave = function(ev){
        const grid = ev.currentTarget.closest('.proj-grid');
        if (grid) grid.classList.remove('is-drop-target');
      };

      window.projDropOnEstado = function(ev){
        ev.preventDefault();
        const grid = ev.currentTarget.closest('.proj-grid');
        if (!grid || !draggedProyectoId) return;

        const nuevoEstado   = grid.dataset.dropEstado;
        const card          = document.querySelector('.proj-card[data-proyecto="' + draggedProyectoId + '"]');
        if (!card) return;

        const oldSection    = card.closest('.proj-section');
        const targetSection = grid.closest('.proj-section');

        // Mover visualmente la tarjeta
        grid.appendChild(card);
        grid.classList.remove('is-drop-target');

        // Actualizar chip de estado y contadores de ambas columnas
        updateCardEstadoChip(card, targetSection);
        updateSectionCount(oldSection);
        updateSectionCount(targetSection);

        // Actualizar estado en el backend
        const url = URL_CAMBIAR_ESTADO.replace('0', draggedProyectoId);
        const fd  = new FormData();
        fd.append('estado', nuevoEstado);
        fd.append('csrfmiddlewaretoken', getCookie('csrftoken') || '');

        fetch(url, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).catch(() => {
          alert('No se pudo cambiar el estado del proyecto.');
        });
      };

    })();
  </script>
{% endblock %}
