{# templates/proyectos/dashboard.html #}
{% extends "_base.html" %}
{% block title %}Proyectos{% endblock %}

{% block content %}
  {# Tarjetas de navegaciÃ³n #}
  {% include "proyectos/_cards_nav.html" %}

  {# BotÃ³n NUEVO arriba de la tabla #}
  {% if perms.proyectos.can_manage_proyectos %}
    <div style="display:flex;justify-content:flex-end;margin:10px 0 6px;">
      <button type="button"
              id="btnNuevoProyecto"
              class="btn btn-primary">
        Nuevo
      </button>
    </div>
  {% endif %}

  {# ============== VENCIMIENTOS agrupados por proyecto (TODAS las tareas con fecha) ============== #}
  {% if current_tab == "vencimientos" %}
    <style>
      .venc-group{ margin:18px 0 10px; }
      .venc-group h3{ margin:0 0 8px; font-size:16px; display:flex; gap:10px; align-items:center; }
      .venc-chip{ background:#eef2ff; color:#1e40af; border-radius:999px; padding:4px 8px; font-weight:600; font-size:12px; }
      .venc-table{ width:100%; border-collapse:collapse; }
      .venc-table th, .venc-table td{ padding:10px 12px; border-top:1px solid #e5e7eb; }
      .venc-table th{ text-align:left; font-weight:700; color:#334155; background:#f8fafc; }
      .venc-table tr:hover td{ background:#fbfdff; }
      .btn-sm{ display:inline-block; padding:6px 10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer }
      .btn-sm:hover{ background:#f8fafc; }

      /* ===== Modal genÃ©rico para tareas / proyectos ===== */
      .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1100; }
      .modal-overlay.open{ display:flex; }
      .modal{ width:clamp(560px, 64vw, 720px); max-width:720px; background:#fff; border-radius:12px; box-shadow:0 10px 35px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; }
      .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; }
      .modal-title{ margin:0; font-size:18px; font-weight:700; color:#1e293b; }
      .modal-body{ padding:16px 18px; max-height:72vh; overflow:auto; }  /* <- para que no crezca infinito */
      .btn-close{ border:none; background:transparent; font-size:22px; line-height:1; cursor:pointer; color:#666; }
    </style>

    {% if vencimientos_grouped and vencimientos_grouped|length > 0 %}
      {% for g in vencimientos_grouped %}
        <div class="venc-group">
          <h3>
            {{ g.proyecto.nombre }}
            <span class="venc-chip">Cierre: {{ g.fecha_cierre|date:"d/m/Y"|default:"â€”" }}</span>
          </h3>

          <table class="venc-table">
            <thead>
              <tr>
                <th style="width:36%">Tarea</th>
                <th style="width:18%">Encargado</th>
                <th style="width:14%">Vence</th>
                <th style="width:18%">Responsable</th>
                <th style="width:14%"></th>
              </tr>
            </thead>
            <tbody>
              {% for t in g.tareas %}
                <tr>
                  <td>{{ t.titulo }}</td>
                  <td>{% if t.asignado_a %}{{ t.asignado_a.get_full_name|default:t.asignado_a.username }}{% else %}â€”{% endif %}</td>
                  <td>{{ t.vence_el|date:"d/m/Y" }}</td>
                  <td>{% if g.proyecto.responsable %}{{ g.proyecto.responsable.get_full_name|default:g.proyecto.responsable.username }}{% else %}â€”{% endif %}</td>
                  <td>
                    <button
                      type="button"
                      class="btn-sm js-open-tarea"
                      data-url="{% url 'proyectos:tarea_detalle_modal' t.id %}"
                      data-title="Tarea: {{ t.titulo|escapejs }}">
                      Ver
                    </button>

                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p style="color:#64748b">No hay tareas con fecha de vencimiento.</p>
    {% endif %}
  {% else %}
    {# ============== otras pestaÃ±as: listado simple de proyectos ============== #}
    <table class="tabla" style="width:100%;border-collapse:collapse;margin-top:6px">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Nombre</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">DescripciÃ³n</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Responsable</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for p in items %}
            <tr>
              <td style="padding:8px;border-bottom:1px solid #f3f3f3">{{ p.nombre }}</td>
              <td style="padding:8px;border-bottom:1px solid #f3f3f3">{{ p.descripcion|truncatechars:120 }}</td>
              <td style="padding:8px;border-bottom:1px solid #f3f3f3">
                {% if p.responsable %}
                  {{ p.responsable.get_full_name|default:p.responsable.username }}
                {% else %}â€”{% endif %}
              </td>
              <td style="padding:8px;border-bottom:1px solid #f3f3f3">
                <a href="{% url 'proyectos:detalle' p.id %}">Ver</a>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" style="padding:10px;color:#666">No hay proyectos en esta secciÃ³n.</td></tr>
        {% endif %}
      </tbody>
    </table>
  {% endif %}

  {% if perms.proyectos.can_manage_proyectos %}
    <div id="modalProyecto" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalProyectoTitle">
        <div class="modal-header">
          <h3 id="modalProyectoTitle" class="modal-title">Nuevo proyecto</h3>
          <button type="button" class="btn-close" id="btnCerrarModalProyecto" aria-label="Cerrar">Ã—</button>
        </div>
        <div class="modal-body">
          <div id="modalProyectoContainer">
            <p style="margin:0;color:#666">Cargando formularioâ€¦</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# ===== Modal GENÃ‰RICO para ver/editar tareas desde el dashboard ===== #}
  <div id="modalGeneral" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalGeneralTitle">
      <div class="modal-header">
        <h3 id="modalGeneralTitle" class="modal-title" style="margin:0">Detalle de tarea</h3>
        <button type="button" class="btn-close" id="btnCloseGeneral" aria-label="Cerrar">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="modalGeneralContainer"><p style="margin:0;color:#666">Cargandoâ€¦</p></div>
      </div>
    </div>
  </div>

  {# ===================== SCRIPTS embebidos (para evitar problemas de bloques) ===================== #}
  <script>
    (function(){
      // URLs desde Django
      const NUEVO_PROY_URL = "{% url 'proyectos:nuevo' %}";

      // ---------- Utilidades modal genÃ©rico ----------
      const $ = (sel, ctx=document) => ctx.querySelector(sel);

      // ----- Modal general de tareas -----
      const modalGeneral = $("#modalGeneral");
      const modalGeneralTitle = $("#modalGeneralTitle");
      const modalGeneralContainer = $("#modalGeneralContainer");
      const btnCloseGeneral = $("#btnCloseGeneral");

      // === NUEVO: enganchar chat al cargar el partial ===
      function attachChatHandlers(){
        const form = $("#chatForm", modalGeneralContainer);
        const list = $("#chatList", modalGeneralContainer);
        const box  = $("#chatBox",  modalGeneralContainer);
        if (!form) return;

        const scrollBottom = () => { if (box) box.scrollTop = box.scrollHeight; };
        scrollBottom();

        form.addEventListener("submit", async function(e){
          e.preventDefault();
          const data = new FormData(form);
          const btn  = form.querySelector('button[type=submit]');
          btn.disabled = true;
          try{
            const r = await fetch(form.action, {
              method: "POST",
              headers: { "X-Requested-With": "XMLHttpRequest" },
              body: data
            });
            const json = await r.json();
            if (json.ok){
              const tmp = document.createElement("div");
              tmp.innerHTML = json.html || "";
              let li = tmp.firstElementChild;
              if (!li){
                li = document.createElement("li");
                li.className = "msg me";
                li.innerHTML = '<div class="bubble"><div class="meta"><strong>Yo</strong> Â· ahora</div><div class="text"></div></div>';
                li.querySelector(".text").textContent = data.get("mensaje") || "";
              }
              list.appendChild(li);
              form.reset();
              scrollBottom();
            } else {
              alert(json.error || "No se pudo enviar el mensaje.");
            }
          } catch(err){
            console.error(err);
            alert("Error de red.");
          } finally {
            btn.disabled = false;
          }
        });
      }

      function openGeneral(url, title){
        modalGeneral.classList.add("open");
        modalGeneral.setAttribute("aria-hidden","false");
        modalGeneralTitle.textContent = title || "Detalle";
        modalGeneralContainer.innerHTML = '<p style="margin:0;color:#666">Cargandoâ€¦</p>';
        const bust = url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();   // â† ðŸ”§
        fetch(bust, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then(r => r.text())
          .then(html => { modalGeneralContainer.innerHTML = html; attachChatHandlers(); })  // <- engancha chat
          .catch(() => { modalGeneralContainer.innerHTML = '<p style="color:#a00">No se pudo cargar el contenido.</p>'; });
      }
      function closeGeneral(){
        modalGeneral.classList.remove("open");
        modalGeneral.setAttribute("aria-hidden","true");
      }
      if (btnCloseGeneral) btnCloseGeneral.addEventListener("click", closeGeneral);
      if (modalGeneral) modalGeneral.addEventListener("click", e => { if (e.target === modalGeneral) closeGeneral(); });
      document.addEventListener("keydown", e => { if (e.key === "Escape") closeGeneral(); });

      // DelegaciÃ³n para botones "Ver" (tareas)
      document.addEventListener("click", function(e){
        const btn = e.target.closest(".js-open-tarea");
        if (!btn) return;
        e.preventDefault();
        openGeneral(btn.dataset.url, btn.dataset.title);
      });

      // ----- Modal "Nuevo proyecto" -----
      const modalProyecto = $("#modalProyecto");
      const modalProyectoContainer = $("#modalProyectoContainer");
      const btnCerrarModalProyecto = $("#btnCerrarModalProyecto");
      const btnNuevoProyecto = $("#btnNuevoProyecto");

      function openNuevoProyecto(){
        if (!modalProyecto) return;
        modalProyecto.classList.add("open");
        modalProyecto.setAttribute("aria-hidden","false");
        modalProyectoContainer.innerHTML = '<p style="margin:0;color:#666">Cargando formularioâ€¦</p>';
        fetch(NUEVO_PROY_URL, { headers: { "X-Requested-With": "XMLHttpRequest" }, cache: "no-store" })
          .then(r => r.text())
          .then(html => { modalProyectoContainer.innerHTML = html; attachProyectoFormHandlers(); })
          .catch(() => { modalProyectoContainer.innerHTML = '<p style="color:#a00">No se pudo cargar el formulario.</p>'; });
      }
      function closeNuevoProyecto(){
        if (!modalProyecto) return;
        modalProyecto.classList.remove("open");
        modalProyecto.setAttribute("aria-hidden","true");
      }
      if (btnNuevoProyecto) btnNuevoProyecto.addEventListener("click", openNuevoProyecto);
      if (btnCerrarModalProyecto) btnCerrarModalProyecto.addEventListener("click", closeNuevoProyecto);
      if (modalProyecto) modalProyecto.addEventListener("click", e => { if (e.target === modalProyecto) closeNuevoProyecto(); });
      document.addEventListener("keydown", e => { if (e.key === "Escape") closeNuevoProyecto(); });

      // Manejo submit AJAX del form de proyecto
      function attachProyectoFormHandlers(){
        const form = $("#formProyecto", modalProyectoContainer);
        const btnCancel = $("#btnCancelarProyecto", modalProyectoContainer);
        if (btnCancel) btnCancel.addEventListener("click", closeNuevoProyecto);
        if (!form) return;
        form.addEventListener("submit", function(e){
          e.preventDefault();
          const formData = new FormData(form);
          const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
          fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
            body: formData
          })
          .then(async (r) => {
            const text = await r.text();
            let data = null;
            try { data = JSON.parse(text); } catch (_) {}
            if (data && data.ok) {
              closeNuevoProyecto();
              if (data.redirect) window.location.href = data.redirect;
              else window.location.reload();
              return;
            }
            if (data && data.html) { modalProyectoContainer.innerHTML = data.html; attachProyectoFormHandlers(); return; }
            if (!data && text.trim().startsWith('<')) { modalProyectoContainer.innerHTML = text; attachProyectoFormHandlers(); return; }
            throw new Error('Respuesta invÃ¡lida del servidor');
          })
          .catch(() => alert('Error de red al guardar.'));
        });
      }

    })();
  </script>
{% endblock %}
