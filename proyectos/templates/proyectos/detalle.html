{% extends "proyectos/_base_proyectos.html" %}
{% load proyectos_extras %}

{% block title %}{{ proyecto.nombre }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
  .breadcrumbs{ display:none !important; }

  .proj-header{
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;margin:6px 0 14px
  }
  .btn{
    display:inline-flex;align-items:center;gap:6px;padding:8px 12px;
    border:1px solid #d0d7de;border-radius:8px;
    background:#fff;text-decoration:none;color:#0f172a;cursor:pointer
  }
  .btn:hover{background:#f8fafc}
  .btn-primary{background:#2563eb;color:#fff !important;border-color:#2563eb}
  .btn-primary:hover{background:#1d4ed8;color:#fff !important}

  .meta-chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;font-weight:600;color:#111827}

  .tasks-top{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .board{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px}
  @media(max-width:1100px){.board{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:820px){.board{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.board{grid-template-columns:1fr}}

  .col{background:#fff;border:1px solid #e5e7eb;border-radius:10px;min-height:120px;padding:10px}
  .col h3{margin:0 0 8px;font-size:15px;color:#0f172a}

  .card{
    position:relative;
    background:#fff;border:1px solid #e5e7eb;border-radius:10px;
    padding:10px;margin-bottom:8px;box-shadow:0 1px 2px rgba(16,24,40,.04)
  }
  .card .meta{color:#64748b;font-size:12px;margin-top:2px}
  .card-actions{position:absolute;top:6px;right:6px;display:flex;gap:6px}
  .link-icon{
    border:0;background:transparent;cursor:pointer;
    font-size:12px;color:#2563eb;padding:4px 6px;border-radius:6px
  }
  .link-icon:hover{background:#eef2ff}

  /* ===== MODAL (overlay + tama√±o ‚Äújusto‚Äù) ===== */
  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none;                 /* üîß default oculto */
    z-index:1200;
    overflow:auto;                /* el overlay scrollea si hace falta */
    padding:24px;
    align-items:center;justify-content:center;
  }
  .modal-overlay.open{display:flex} /* üîß se muestra al abrir */

  .modal{
    background:#fff;border-radius:12px;box-shadow:0 10px 35px rgba(0,0,0,.25);
    width:clamp(560px, 64vw, 720px);   /* m√°s angosto y c√≥modo */
    max-width:720px;
    max-height:none;                   /* sin tope de alto: scrollea overlay */
    display:flex;flex-direction:column;
    animation:fadeIn .25s ease;
    overflow:hidden;
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:none;}}
  @media (max-width:600px){ .modal{ width:94vw; } }

  .modal *{box-sizing:border-box;}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee}
  .modal-title{margin:0;font-weight:700;color:#1e293b;font-size:18px}
  .modal-body{padding:16px 18px;}     /* sin overflow interno */
  .btn-close{border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#666}

  /* ===== FORM ESTILO dentro del modal ===== */
  #modalContainer #formTarea label{display:block;font-weight:600;margin:6px 0 4px;color:#0f172a}
  #modalContainer #formTarea input,
  #modalContainer #formTarea select,
  #modalContainer #formTarea textarea{
    width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:10px 12px;font-size:15px;
  }
  #modalContainer #formTarea textarea{min-height:120px;}
  #modalContainer #formTarea .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px;}
  @media(max-width:720px){#modalContainer #formTarea .grid-2{grid-template-columns:1fr}}
  #modalContainer #formTarea .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:22px}
</style>
{% endblock %}

{% block contenido %}
<div class="proj-header">
  <a class="btn" href="{% url 'proyectos:dashboard' %}"
     onclick="if (history.length > 1){history.back();return false;}">‚Üê Volver</a>

  <!-- IMPORTANTE: apuntamos a la vista modal -->
  <a class="btn btn-primary" id="btnEditarProyecto" href="{% url 'proyectos:editar_modal' proyecto.id %}">
    Editar proyecto
  </a>
</div>

<h1 style="margin:0 0 4px">{{ proyecto.nombre }}</h1>

<div class="meta-chips">
  <span class="chip">Prioridad: {{ proyecto.get_prioridad_display }}</span>
  <span class="chip">Responsable: {{ proyecto.responsable|default:"‚Äî" }}</span>
</div>

{% if proyecto.descripcion %}
  <p style="margin:10px 0 14px;color:#334155;max-width:80ch">{{ proyecto.descripcion }}</p>
{% endif %}

<hr>

<div class="tasks-top">
  <h2 style="margin:0">Tareas</h2>
  <button class="btn btn-primary" id="btnNuevaTarea" data-url="{% url 'proyectos:tarea_crear' proyecto.id %}">+ Nueva tarea</button>
</div>

<div class="board">
  {% for key,titulo in estados.items %}
    <div class="col" data-estado="{{ key }}" ondragover="allowDrop(event)" ondrop="dropOnColumn(event)">
      <h3>{{ titulo }}</h3>
      {% for t in cols|get_item:key %}
        <div class="card" draggable="true" data-tarea="{{ t.id }}" ondragstart="dragTask(event)">
          <div class="card-actions">
            <button type="button" class="link-icon js-edit-task" title="Editar"
                    data-url="{% url 'proyectos:tarea_editar' t.id %}">Editar</button>
          </div>
          <div style="font-weight:600; padding-right:56px">{{ t.titulo }}</div>
          <div class="meta">
            {% if t.vence_el %}{{ t.vence_el|date:"d/m/Y" }}{% else %}‚Äî{% endif %} ¬∑
            {{ t.get_prioridad_display }} ¬∑
            {% if t.asignado_a %}{{ t.asignado_a }}{% else %}‚Äî{% endif %}
          </div>
        </div>
      {% empty %}
        <div class="meta">Sin tareas.</div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalGeneral" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Cargando‚Ä¶</h3>
      <button type="button" class="btn-close" id="closeModal">√ó</button>
    </div>
    <div class="modal-body">
      <div id="modalContainer"><p style="margin:0;color:#666">Cargando contenido‚Ä¶</p></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function addModalFlag(url){ return url.includes('?') ? url + '&modal=1' : url + '?modal=1'; }
function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }

let draggedId = null;
function dragTask(ev){ draggedId = ev.currentTarget.dataset.tarea; ev.dataTransfer.effectAllowed = 'move'; }
function allowDrop(ev){ ev.preventDefault(); }
function dropOnColumn(ev){
  ev.preventDefault();
  const col = ev.currentTarget.closest('[data-estado]');
  if(!col || !draggedId) return;
  const nuevo = col.dataset.estado;
  const card = document.querySelector('[data-tarea="'+draggedId+'"]');
  if(card) col.appendChild(card);
  const url = "{% url 'proyectos:tarea_cambiar_estado' 0 %}".replace('0', draggedId);
  const fd  = new FormData();
  fd.append('estado', nuevo);
  fd.append('csrfmiddlewaretoken', getCookie('csrftoken') || '');
  fetch(url, { method:'POST', body:fd }).finally(()=>{ draggedId = null; });
}

let _currentModalUrl = null;

function openModal(titulo, url){
  const ov=document.getElementById('modalGeneral');
  const title=document.getElementById('modalTitle');
  const cont=document.getElementById('modalContainer');
  _currentModalUrl=url;
  ov.classList.add('open');
  ov.setAttribute('aria-hidden','false');
  title.textContent=titulo;
  cont.innerHTML='<p style="color:#555">Cargando formulario‚Ä¶</p>';
  document.documentElement.style.overflow='hidden';
  document.body.style.overflow='hidden';
  fetch(addModalFlag(url),{headers:{'X-Requested-With':'XMLHttpRequest'}})
    .then(r=>r.text())
    .then(html=>{
      cont.innerHTML=html;
      hookTareaForm();      // si es el form de tarea
      hookProyectoForm();   // si es el form de proyecto
    })
    .catch(()=>cont.innerHTML='<p style="color:#a00">Error al cargar.</p>');
}

function closeModal(){
  const ov=document.getElementById('modalGeneral');
  ov.classList.remove('open');
  ov.setAttribute('aria-hidden','true');
  document.documentElement.style.overflow='';
  document.body.style.overflow='';
}

document.getElementById('closeModal').addEventListener('click',closeModal);
document.getElementById('modalGeneral').addEventListener('click',e=>{if(e.target.id==='modalGeneral')closeModal();});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

/* Nueva tarea */
document.getElementById('btnNuevaTarea').addEventListener('click',e=>{
  e.preventDefault();openModal('Nueva tarea',e.currentTarget.dataset.url);
});

/* Editar tarea desde la tarjeta */
document.querySelector('.board').addEventListener('click',e=>{
  const btn=e.target.closest('.js-edit-task');if(!btn)return;
  e.preventDefault();openModal('Editar tarea',btn.dataset.url);
});

/* Editar proyecto (abre modal y env√≠a por AJAX) */
const btnEditProj = document.getElementById('btnEditarProyecto');
if (btnEditProj){
  btnEditProj.addEventListener('click', (e)=>{
    e.preventDefault();
    openModal('Editar proyecto', btnEditProj.href);
  });
}

/* ===== Hooks de formularios incrustados ===== */
function hookTareaForm(){
  const form=document.getElementById('formTarea');
  if(!form)return;
  if(!form.getAttribute('action'))form.setAttribute('action',_currentModalUrl);
  const selAsignado=document.getElementById('id_asignado_a');
  if(selAsignado){
    Array.from(selAsignado.options).forEach(opt=>{
      if((opt.textContent||'').trim().toLowerCase()==='admin')opt.remove();
    });
  }
  const btnCancelar=document.getElementById('btnCancelarTarea');
  if(btnCancelar)btnCancelar.addEventListener('click',closeModal);
  form.addEventListener('submit',function(e){
    e.preventDefault();
    const fd=new FormData(form);
    fetch(form.action,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest'},body:fd})
    .then(r=>r.json())
    .then(data=>{
      if(data.ok){closeModal();location.reload();}
      else if(data.html){document.getElementById('modalContainer').innerHTML=data.html;hookTareaForm();}
      else{alert('No se pudo guardar la tarea.');}
    })
    .catch(()=>alert('Error de red al guardar.'));
  });
}

function hookProyectoForm(){
  const form = document.getElementById('formProyecto');
  if(!form) return;

  // Asegura action correcta por si el partial no la setea
  if(!form.getAttribute('action')){
    form.setAttribute('action', document.getElementById('btnEditarProyecto').href);
  }

  const btnCancelar = document.getElementById('btnCancelarProyecto');
  if (btnCancelar) btnCancelar.addEventListener('click', closeModal);

  form.addEventListener('submit', function(ev){
    ev.preventDefault();
    const fd = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest'},
      body: fd
    })
    .then(r => r.json().then(data => ({ok:r.ok, data})))
    .then(({ok, data})=>{
      if (data.ok){
        closeModal();
        location.reload();
      } else if (data.html){
        document.getElementById('modalContainer').innerHTML = data.html;
        hookProyectoForm();
      } else {
        alert('No se pudo guardar el proyecto.');
      }
    })
    .catch(()=> alert('Error de red al guardar.'));
  });
}

/* ===== Abrir modal de TAREA autom√°ticamente si viene desde notificaci√≥n ===== */
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  const openTask = params.get('open_task');
  if (openTask){
    // Carga el DETALLE de la tarea en modal
    const url = "{% url 'proyectos:tarea_detalle_modal' 0 %}".replace('0', openTask);
    openModal('Detalle de tarea', url);
    // limpia el query param para que no se reabra en refresh
    history.replaceState({}, '', location.pathname);
  }
});
</script>
{% endblock %}
