{% extends "proyectos/_base_proyectos.html" %}
{% load proyectos_extras %}

{% block title %}{{ proyecto.nombre }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
  .breadcrumbs{ display:none !important; }

  .proj-header{
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;margin:6px 0 14px
  }
  .btn{
    display:inline-flex;align-items:center;gap:6px;padding:8px 12px;
    border:1px solid #d0d7de;border-radius:8px;
    background:#fff;text-decoration:none;color:#0f172a;cursor:pointer
  }
  .btn:hover{background:#f8fafc}
  .btn-primary{background:#2563eb;color:#fff !important;border-color:#2563eb}
  .btn-primary:hover{background:#1d4ed8;color:#fff !important}

  .meta-chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;font-weight:600;color:#111827;display:inline-flex;align-items:center;gap:8px}

  .tasks-top{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .board{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px}
  @media(max-width:1100px){.board{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:820px){.board{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:560px){.board{grid-template-columns:1fr}}

  .col{background:#fff;border:1px solid #e5e7eb;border-radius:10px;min-height:120px;padding:10px}
  .col h3{margin:0 0 8px;font-size:15px;color:#0f172a}

  .card{
    position:relative;
    background:#fff;border:1px solid #e5e7eb;border-radius:10px;
    padding:10px;margin-bottom:8px;box-shadow:0 1px 2px rgba(16,24,40,.04)
  }
  .card .meta{color:#64748b;font-size:12px;margin-top:2px}
  .card-actions{position:absolute;top:6px;right:6px;display:flex;gap:6px}
  .link-icon{
    border:0;background:transparent;cursor:pointer;
    font-size:12px;color:#2563eb;padding:4px 6px;border-radius:6px
  }
  .link-icon:hover{background:#eef2ff}

  /* ===== MODAL ===== */
  .modal-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; z-index:1200; overflow:auto; padding:24px;
    align-items:center;justify-content:center;
  }
  .modal-overlay.open{display:flex}
  .modal{
    background:#fff;border-radius:12px;box-shadow:0 10px 35px rgba(0,0,0,.25);
    width:clamp(560px, 64vw, 720px); max-width:720px; max-height:none;
    display:flex;flex-direction:column; animation:fadeIn .25s ease; overflow:hidden;
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:none;}}
  @media (max-width:600px){ .modal{ width:94vw; } }
  .modal *{box-sizing:border-box;}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee}
  .modal-title{margin:0;font-weight:700;color:#1e293b;font-size:18px}
  .modal-body{padding:16px 18px;}
  .btn-close{border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#666}

  /* ===== FORM estilo dentro del modal ===== */
  #modalContainer #formTarea label{display:block;font-weight:600;margin:6px 0 4px;color:#0f172a}
  #modalContainer #formTarea input,
  #modalContainer #formTarea select,
  #modalContainer #formTarea textarea{
    width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:10px 12px;font-size:15px;
  }
  #modalContainer #formTarea textarea{min-height:120px;}
  #modalContainer #formTarea .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px;}
  @media(max-width:720px){#modalContainer #formTarea .grid-2{grid-template-columns:1fr}}
  #modalContainer #formTarea .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:22px}
</style>
{% endblock %}

{% block contenido %}
<div class="proj-header">
  <a class="btn" href="{% url 'proyectos:dashboard' %}"
     onclick="if (history.length > 1){history.back();return false;}">← Volver</a>

  <a class="btn btn-primary" id="btnEditarProyecto" data-url="{% url 'proyectos:editar_modal' proyecto.id %}">
    Editar proyecto
  </a>
</div>

<h1 style="margin:0 0 4px">{{ proyecto.nombre }}</h1>

<div class="meta-chips">
  <span class="chip">Prioridad: {{ proyecto.get_prioridad_display }}</span>
  <span class="chip">Responsable: {{ proyecto.responsable|default:"—" }}</span>

  <span class="chip">
    Estado:
    <select id="selectEstadoProyecto"
            data-url="{% url 'proyectos:proyecto_cambiar_estado' proyecto.id %}"
            style="border:1px solid #cbd5e1;border-radius:999px;background:#fff;padding:4px 8px;font-weight:600;">
      {% for val, label in proyecto.ESTADOS %}
        <option value="{{ val }}" {% if proyecto.estado == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </span>
</div>

{% if proyecto.descripcion %}
  <p style="margin:10px 0 14px;color:#334155;max-width:80ch">{{ proyecto.descripcion }}</p>
{% endif %}

<hr>

<div class="tasks-top">
  <h2 style="margin:0">Tareas</h2>
  <button class="btn btn-primary" type="button" id="btnNuevaTarea"
          data-url="{% url 'proyectos:tarea_crear' proyecto.id %}">+ Nueva tarea</button>
</div>

<div class="board">
  {% for key,titulo in estados.items %}
    <div class="col" data-estado="{{ key }}" ondragover="allowDrop(event)" ondrop="dropOnColumn(event)">
      <h3>{{ titulo }}</h3>
      {% for t in cols|get_item:key %}
        <div class="card" draggable="true" data-tarea="{{ t.id }}" ondragstart="dragTask(event)">
          <div class="card-actions">
            <button type="button"
                    class="link-icon js-edit-task"
                    title="Editar"
                    data-url="{% url 'proyectos:tarea_editar' t.id %}">Editar</button>

            <button type="button"
                    class="link-icon js-delete-task"
                    title="Eliminar"
                    data-url="{% url 'proyectos:tarea_eliminar' t.id %}">Eliminar</button>
          </div>
          <div style="font-weight:600; padding-right:56px">{{ t.titulo }}</div>
          <div class="meta">
            {% if t.vence_el %}{{ t.vence_el|date:"d/m/Y" }}{% else %}—{% endif %} ·
            {{ t.get_prioridad_display }} ·
            {% with users=t.asignados.all %}
              {% if users %}
                {% for u in users %}{{ u }}{% if not forloop.last %}, {% endif %}{% endfor %}
              {% else %}—{% endif %}
            {% endwith %}
          </div>
        </div>
      {% empty %}
        <div class="meta">Sin tareas.</div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalGeneral" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Cargando…</h3>
      <button type="button" class="btn-close" id="closeModal">×</button>
    </div>
    <div class="modal-body">
      <div id="modalContainer"><p style="margin:0;color:#666">Cargando contenido…</p></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  /* ===== Helpers ===== */
  function addModalFlag(url){ return url.includes('?') ? url + '&modal=1' : url + '?modal=1'; }
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():'';
  }

  /* ===== Drag & Drop ===== */
  window.dragTask = function(ev){ window._draggedId = ev.currentTarget.dataset.tarea; ev.dataTransfer.effectAllowed='move'; };
  window.allowDrop = function(ev){ ev.preventDefault(); };
  window.dropOnColumn = function(ev){
    ev.preventDefault();
    const col = ev.currentTarget.closest('[data-estado]');
    if(!col || !window._draggedId) return;
    const nuevo = col.dataset.estado;
    const card = document.querySelector('[data-tarea="'+window._draggedId+'"]');
    if(card) col.appendChild(card);
    const url = "{% url 'proyectos:tarea_cambiar_estado' 0 %}".replace('0', window._draggedId);
    const fd  = new FormData();
    fd.append('estado', nuevo);
    fd.append('csrfmiddlewaretoken', getCookie('csrftoken') || '');
    fetch(url, { method:'POST', body:fd, credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'} })
      .finally(()=>{ window._draggedId = null; });
  };

  /* ===== Modal ===== */
  let CURRENT_URL = null;
  const overlay  = document.getElementById('modalGeneral');
  const titleEl  = document.getElementById('modalTitle');
  const contEl   = document.getElementById('modalContainer');

  function openModal(titulo, url){
    CURRENT_URL = url;
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden','false');
    titleEl.textContent = titulo;
    contEl.innerHTML = '<p style="color:#555">Cargando…</p>';
    document.documentElement.style.overflow='hidden';
    document.body.style.overflow='hidden';

    fetch(addModalFlag(url), { headers:{'X-Requested-With':'XMLHttpRequest'}, cache:'no-store' })
      .then(r => r.text())
      .then(html => {
        contEl.innerHTML = html;
        hookTareaForm();
        hookProyectoForm();
      })
      .catch(() => contEl.innerHTML = '<p style="color:#a00">Error al cargar.</p>');
  }
  function closeModal(){
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow='';
    document.body.style.overflow='';
  }
  (function bindModalChrome(){
    const closeBtn = document.getElementById('closeModal');
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
  })();

  /* ===== Delegated clicks ===== */
  document.addEventListener('click', async (e)=>{
    // Nueva tarea
    const btnNew = e.target.closest('#btnNuevaTarea');
    if (btnNew){
      e.preventDefault();
      const url = btnNew.getAttribute('data-url');
      if (url) openModal('Nueva tarea', url);
      return;
    }

    // Editar tarea
    const btnEditTask = e.target.closest('.js-edit-task');
    if (btnEditTask){
      e.preventDefault();
      const url = btnEditTask.getAttribute('data-url');
      if (url) openModal('Editar tarea', url);
      return;
    }

    // Eliminar tarea
    const btnDel = e.target.closest('.js-delete-task');
    if (btnDel){
      e.preventDefault();
      if(!confirm('¿Eliminar esta tarea de forma definitiva?')) return;

      const url = btnDel.getAttribute('data-url');
      if(!url) return;

      const fd = new FormData();
      fd.append('csrfmiddlewaretoken', getCookie('csrftoken') || '');

      try{
        const resp = await fetch(url, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: { 'X-Requested-With':'XMLHttpRequest' }
        });
        if (!resp.ok){
          try { const data = await resp.json(); if (!data.ok) throw 0; } catch(_){ throw 0; }
        }
        const card = btnDel.closest('.card');
        if (card) card.remove();
      }catch(err){
        alert('No se pudo eliminar la tarea.');
      }
      return;
    }

    // Editar proyecto
    const btnEditProj = e.target.closest('#btnEditarProyecto');
    if (btnEditProj){
      e.preventDefault();
      const url = btnEditProj.getAttribute('data-url');
      if (url) openModal('Editar proyecto', url);
      return;
    }
  });

  /* ===== AJAX form helper ===== */
  async function submitAjaxForm(form, onSuccess){
    const fd = new FormData(form);
    const headers = {'X-Requested-With':'XMLHttpRequest'};
    const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    if (csrf) headers['X-CSRFToken'] = csrf;

    const resp = await fetch(form.action || CURRENT_URL, { method:'POST', headers, body:fd, credentials:'same-origin' });
    const ct = resp.headers.get('content-type') || '';
    const txt = await resp.text();

    try{
      const data = JSON.parse(txt);
      if (data.ok){ onSuccess(data); return; }
      if (data.html){ contEl.innerHTML = data.html; return 'replace'; }
    }catch(_){}

    if (ct.includes('text/html')){
      if (txt.includes('<form') && txt.includes('</form>')){ contEl.innerHTML = txt; return 'replace'; }
      onSuccess({}); return;
    }

    if (resp.ok){ onSuccess({}); return; }
    throw new Error('Respuesta inválida del servidor');
  }

  /* ===== Hooks de formularios dentro del modal ===== */
  // >>>>>>>>>> CORREGIDO: versión con delegación para la "X" de los chips <<<<<<<<<<
  window.hookTareaForm = function(){
    const form = contEl.querySelector('#formTarea');
    if (!form) return;

    if (!form.getAttribute('action')) form.setAttribute('action', CURRENT_URL);

    const sel       = contEl.querySelector('#id_asignados');      // <select multiple> oculto
    const chipsWrap = contEl.querySelector('#chipsAsignados');    // contenedor de chips visibles
    const btnAdd    = contEl.querySelector('#btnAddAsignado');    // botón "+"

    // limpiar "admin"
    if (sel){
      Array.from(sel.options).forEach(opt=>{
        if((opt.textContent||'').trim().toLowerCase()==='admin') opt.remove();
      });
    }

    function renderChips(){
      if (!sel || !chipsWrap) return;
      const selected = Array.from(sel.options).filter(o=>o.selected);
      if (!selected.length){
        chipsWrap.innerHTML = '<span class="chip chip-empty">Sin asignados</span>';
        return;
      }
      chipsWrap.innerHTML = selected.map(o =>
        `<span class="chip" data-val="${o.value}">
           <span>${o.text}</span>
           <button type="button" class="rm" title="Quitar" aria-label="Quitar">×</button>
         </span>`
      ).join('');
    }

    // render inicial + re-render por cambios del select oculto
    renderChips();
    sel?.addEventListener('change', renderChips);

    // ✅ Delegación: quitar asignado al clickear la X
    chipsWrap?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.rm');
      if (!btn) return;
      const chip = btn.closest('.chip');
      if (!chip) return;
      const val = chip.dataset.val;
      Array.from(sel.options).forEach(o => { if (o.value === val) o.selected = false; });
      renderChips();
    });

    // Mini menú con los no-seleccionados
    function openMiniMenu(anchor){
      const notSelected = Array.from(sel.options).filter(o=>!o.selected);
      if (!notSelected.length) return;

      const menu = document.createElement('div');
      menu.className = 'mini-menu';
      menu.innerHTML = notSelected.map(o=>`<button type="button" class="mini-item" data-val="${o.value}">${o.text}</button>`).join('');
      document.body.appendChild(menu);

      const r = anchor.getBoundingClientRect();
      Object.assign(menu.style, {
        position:'fixed', top:(r.bottom+6)+'px', left:r.left+'px', zIndex:99999,
        minWidth:'180px', background:'#fff', border:'1px solid #e5e7eb',
        borderRadius:'10px', boxShadow:'0 8px 24px rgba(0,0,0,.12)', padding:'6px'
      });

      function close(){
        menu.remove();
        document.removeEventListener('click', onDoc, true);
        window.removeEventListener('resize', close);
        window.removeEventListener('scroll', close, true);
      }
      function onDoc(e){ if (!menu.contains(e.target) && e.target!==anchor) close(); }

      menu.querySelectorAll('.mini-item').forEach(it=>{
        Object.assign(it.style, {
          display:'block', width:'100%', textAlign:'left', padding:'8px 10px',
          borderRadius:'8px', border:'0', background:'transparent', cursor:'pointer'
        });
        it.addEventListener('mouseenter', ()=> it.style.background='#f8fafc');
        it.addEventListener('mouseleave', ()=> it.style.background='transparent');
        it.addEventListener('click', ()=>{
          const val = it.getAttribute('data-val');
          Array.from(sel.options).forEach(o=>{ if (o.value===val) o.selected=true; });
          renderChips();
          close();
        });
      });

      document.addEventListener('click', onDoc, true);
      window.addEventListener('resize', close);
      window.addEventListener('scroll', close, true);
    }

    btnAdd?.addEventListener('click', ()=>{ if (sel) openMiniMenu(btnAdd); });

    // Cancelar modal
    const btnCancel = contEl.querySelector('#btnCancelarTarea');
    if (btnCancel) btnCancel.addEventListener('click', ()=> {
      document.getElementById('modalGeneral')?.classList.remove('open');
      document.documentElement.style.overflow=''; document.body.style.overflow='';
    });

    // Submit AJAX
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      try{
        const result = await submitAjaxForm(form, ()=>{ location.reload(); });
        if (result === 'replace'){ hookTareaForm(); }
      }catch(_){ alert('No se pudo guardar la tarea.'); }
    });
  };

  window.hookProyectoForm = function(){
    const form = contEl.querySelector('#formProyecto');
    if (!form) return;

    if (!form.getAttribute('action')) form.setAttribute('action', CURRENT_URL);

    const btnCancel = contEl.querySelector('#btnCancelarProyecto');
    if (btnCancel) btnCancel.addEventListener('click', ()=> {
      document.getElementById('modalGeneral')?.classList.remove('open');
      document.documentElement.style.overflow=''; document.body.style.overflow='';
    });

    form.addEventListener('submit', async function(ev){
      ev.preventDefault();
      try{
        const result = await submitAjaxForm(form, (data)=>{
          if (data?.redirect) window.location.href = data.redirect;
          else location.reload();
        });
        if (result === 'replace'){ hookProyectoForm(); }
      }catch(_){ alert('No se pudo guardar el proyecto.'); }
    });
  };

  /* ===== Abrir modal directo si viene ?open_task=ID ===== */
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(location.search);
    const openTask = params.get('open_task');
    if (openTask){
      const url = "{% url 'proyectos:tarea_detalle_modal' 0 %}".replace('0', openTask);
      openModal('Detalle de tarea', url);
      history.replaceState({}, '', location.pathname);
    }
  });

  /* ===== Cambio de estado del proyecto (AJAX) ===== */
  (function(){
    const sel = document.getElementById('selectEstadoProyecto'); if (!sel) return;
    const url = sel.getAttribute('data-url');
    function flashOK(){ sel.style.boxShadow = '0 0 0 3px rgba(34,197,94,.35)'; setTimeout(()=> sel.style.boxShadow = '', 900); }
    function flashError(){ sel.style.boxShadow = '0 0 0 3px rgba(239,68,68,.35)'; setTimeout(()=> sel.style.boxShadow = '', 1200); }

    sel.addEventListener('change', async function(){
      try{
        const fd = new FormData();
        fd.append('estado', sel.value);
        fd.append('csrfmiddlewaretoken', getCookie('csrftoken') || '');
        const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'X-Requested-With':'XMLHttpRequest' }});
        const data = await resp.json(); if (!resp.ok || !data.ok) throw 0; flashOK();
      }catch(_){ flashError(); alert('No se pudo cambiar el estado del proyecto.'); }
    });
  })();

})();
</script>
{% endblock %}
