{# templates/perfil.html #}
{% extends "_base.html" %}

{% block title %}Perfil de {{ request.user.username }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
  .grid-accesos{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
    gap:14px;
    margin:12px 0 20px;
  }
  /* Card */
  .acceso{
    border:1px solid #e5e7eb;
    border-radius:12px;
    background:#fff;
    box-shadow:0 1px 2px rgba(16,24,40,.04);
    transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .acceso:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 15px -3px rgba(16,24,40,.08),0 4px 6px -4px rgba(16,24,40,.08);
    border-color:#d0d7de;
  }
  /* Contenido clickeable */
  .acc-link{
    display:flex;
    align-items:flex-start;
    gap:12px;
    text-decoration:none;
    color:inherit;
    width:100%;
    padding:14px 14px 16px;
    border:none;
    background:transparent;
    text-align:left;
    cursor:pointer;
    border-radius:12px;
  }
  .acc-link:focus-visible{
    outline:none;
    box-shadow:0 0 0 3px rgba(56,97,251,.25);
  }
  .acc-icon{
    width:40px;height:40px;display:grid;place-items:center;
    font-size:20px;border-radius:10px;flex:0 0 auto;
    background:linear-gradient(180deg,#f4f8ff,#ecf2ff);
    color:#3861fb;
  }
  .acc-text{ display:flex; flex-direction:column; gap:6px; }
  .acc-title{ font-weight:700; }
  .acc-desc{ color:#667085; font-size:14px; line-height:1.35; margin:0; }

  /* ‚Äî‚Äî‚Äî T√≠tulo est√©tico ‚Äî‚Äî‚Äî */
  .perfil-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:10px;
  }
  .perfil-icon{
    width:44px;height:44px;
    border-radius:12px;
    background:linear-gradient(180deg,#eff6ff,#e0e7ff);
    display:grid;place-items:center;
    color:#1d4ed8;
    font-size:22px;
    box-shadow:0 4px 10px rgba(29,78,216,.15);
  }
  .perfil-title{
    margin:0;
    font-weight:800;
    letter-spacing:-.02em;
    font-size:clamp(22px,2vw,30px);
    line-height:1.1;
    background:linear-gradient(90deg,#0f172a,#334155);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
  }

  .linklike{ font-weight:600; background:none; border:none; padding:0; cursor:pointer; color:#2c7be5; }
  .linklike:hover{ text-decoration:underline; }
  .badge-enviada{ background:#e7f1ff; color:#1a73e8; padding:2px 8px; border-radius:10px; font-size:12px; }
  table.perfil-txs, table.perfil-horas{ width:100%; border-collapse:collapse; }
  table.perfil-txs th, table.perfil-txs td, table.perfil-horas th, table.perfil-horas td{ padding:8px; border-bottom:1px solid #eee; text-align:left; }
  table.perfil-txs th, table.perfil-horas th{ background:#fafafa; }

  /* Subtabla de detalles de horas */
  .detalle-row td{ background:#fbfdff; }
  .subtabla{ width:100%; border-collapse:collapse; }
  .subtabla th, .subtabla td{ padding:8px; border-bottom:1px solid #eef2f7; text-align:left; }
  .subtabla th{ background:#f8fafc; color:#334155; }

  /* Modal gen√©rico */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal-overlay.open{ display:flex; }
  .modal{ width:min(900px, 92vw); max-height:88vh; overflow:auto; background:#fff; border-radius:10px; box-shadow:0 10px 35px rgba(0,0,0,.25); }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; }
  .modal-title{ margin:0; font-size:18px; font-weight:700; }
  .modal-body{ padding:14px 16px; }
  .btn-close{ border:none; background:transparent; font-size:22px; line-height:1; cursor:pointer; color:#666; }

  /* Bot√≥n "Ver" como link */
  .btn-link { border:none; background:transparent; color:#2c7be5; cursor:pointer; font-weight:600; padding:0; }
  .btn-link:hover { text-decoration:underline; }

  /* ===== Cards ‚ÄúMis tareas‚Äù ===== */
  .tareas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin-top: 10px;
  }
  .tarea-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .tarea-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.07);
    border-color: #d1d5db;
  }
  .tarea-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .tarea-actions {
    display:flex;
    gap:8px;
    align-items:center;
  }
  .tarea-titulo {
    font-weight: 700;
    font-size: 16px;
    color: #111827;
  }
  .tarea-proyecto {
    font-size: 14px;
    color: #6b7280;
    margin-top: 4px;
  }
  .tarea-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
  }
  .lbl { color: #6b7280; font-weight: 600; margin-right: 4px; }
  .badge {
    background: #f1f5f9;
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #1e293b;
  }
  .btn-detalle {
    border: none;
    background: #eff6ff;
    color: #2563eb;
    font-weight: 600;
    border-radius: 6px;
    padding: 4px 10px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .btn-detalle:hover { background: #dbeafe; }

  /* Botones de acci√≥n en cards */
  .btn-tomar,
  .btn-estado{
    border:none;
    font-weight:700;
    border-radius:6px;
    padding:4px 10px;
    cursor:pointer;
    transition:opacity .15s ease, background .15s ease;
    color:#fff;
  }
  .btn-tomar{ background:#2563eb; }
  .btn-tomar:hover{ opacity:.9; }

  .btn-start{ background:#f59e0b; }     /* Empezar */
  .btn-start:hover{ background:#d97706; }
  .btn-finish{ background:#16a34a; }    /* Terminada */
  .btn-finish:hover{ background:#15803d; }

  /* ===== NUEVO: filtro junto al t√≠tulo ===== */
  .tareas-head{
    margin-top:28px;
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .tareas-filter{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .filter-btn{
    border:1px solid #e5e7eb;
    background:#fff;
    color:#0f172a;
    border-radius:999px;
    padding:4px 10px;
    font-weight:600;
    font-size:13px;
    cursor:pointer;
  }
  .filter-btn.is-active{
    background:#2563eb;
    border-color:#2563eb;
    color:#fff;
  }

    .horas-header{
    margin-top:28px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .horas-filter{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    font-size:14px;
  }
  .horas-filter label{
    display:flex;
    align-items:center;
    gap:4px;
  }
  .btn-sm-horas{
    display:inline-block;
    padding:6px 10px;
    border:1px solid #d0d7de;
    border-radius:8px;
    background:#fff;
    cursor:pointer;
  }
  .btn-sm-horas:hover{ background:#f8fafc; }


</style>
{% endblock %}

{% block content %}
<div class="perfil-header">
  <div class="perfil-icon">üë§</div>
  <h1 class="perfil-title">Perfil de usuario</h1>
</div>

<p>Seleccion√° el √°rea a la que quer√©s acceder:</p>

<div class="grid-accesos">
  {# ECONOM√çA #}
  {% if perms.proyectos.can_manage_economia or perms.economia.view_dashboard %}
  <div class="acceso">
    <a class="acc-link" href="{% url 'economia:dashboard' %}">
      <span class="acc-icon" aria-hidden="true">üí∞</span>
      <span class="acc-text">
        <span class="acc-title">Econom√≠a</span>
        <span class="acc-desc">Panel de Econom√≠a.</span>
      </span>
    </a>
  </div>
  {% endif %}

  {# Carga de transacci√≥n/gasto #}
  {% if perms.proyectos.can_manage_economia or perms.economia.can_add_ingresos or perms.economia.add_transaccion or perms.economia.can_add_gastos or perms.economia.add_gasto %}
  <div class="acceso">
    <button type="button" class="acc-link" id="btnNuevaTransaccion">
      <span class="acc-icon" aria-hidden="true">üßæ</span>
      <span class="acc-text">
        <span class="acc-title">
          {% if perms.proyectos.can_manage_economia or perms.economia.view_dashboard %}
            {% if perms.economia.can_add_ingresos or perms.economia.add_transaccion %}
              Nueva Transacci√≥n
            {% else %}
              Nuevo Gasto
            {% endif %}
          {% else %}
            Nuevo Gasto
          {% endif %}
        </span>
        <span class="acc-desc">
          {% if perms.proyectos.can_manage_economia or perms.economia.view_dashboard %}
            {% if perms.economia.can_add_ingresos or perms.economia.add_transaccion %}
              Registrar ingresos o gastos.
            {% else %}
              Registrar un gasto.
            {% endif %}
          {% else %}
            Registrar un gasto.
          {% endif %}
        </span>
      </span>
    </button>
  </div>
  {% endif %}

  {% if perms.proyectos.view_proyecto %}
  <div class="acceso">
    <a class="acc-link" href="{% url 'proyectos:dashboard' %}">
      <span class="acc-icon" aria-hidden="true">üìã</span>
      <span class="acc-text">
        <span class="acc-title">Proyectos</span>
        <span class="acc-desc">Ver y gestionar los proyectos.</span>
      </span>
    </a>
  </div>
  {% endif %}

  <div class="acceso">
    <button type="button" class="acc-link" id="btnCargarHoras">
      <span class="acc-icon" aria-hidden="true">‚è±Ô∏è</span>
      <span class="acc-text">
        <span class="acc-title">Cargar horas</span>
        <span class="acc-desc">Registr√° tus horas de trabajo.</span>
      </span>
    </button>
  </div>
</div>

<h2 class="tareas-head">
  <span>Mis transacciones enviadas</span>
</h2>
{% if mis_pendientes %}
  <table class="perfil-txs">
    <thead><tr><th>Fecha</th><th>Importe</th><th>Descripci√≥n</th><th>Estado</th><th>Editar</th></tr></thead>
    <tbody>
      {% for t in mis_pendientes %}
        <tr>
          <td>{{ t.fecha|date:"d/m/Y" }}</td>
          <td>${{ t.monto }}</td>
          <td>{{ t.descripcion }}</td>
          <td><span class="badge-enviada">Enviada</span></td>
          <td>
            {% if perms.economia.can_edit_own_transactions and t.estado == 'pendiente' and t.usuario_id == request.user.id %}
              {# >>> EDITAR: abre el mismo modal de "Nueva transacci√≥n" con pk para precargar #}
              <a
                href="{% url 'economia:nuevo' %}?modal=1&pk={{ t.id }}"
                class="btn-link js-open-modal"
                data-modal-url="{% url 'economia:nuevo' %}?modal=1&pk={{ t.id }}"
              >Editar</a>
            {% else %}‚Äî{% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No ten√©s transacciones pendientes.</p>
{% endif %}

{# ========= MIS TAREAS ASIGNADAS ========= #}

{# NUEVO: t√≠tulo + filtro al lado #}
<h2 class="tareas-head">
  <span>Mis tareas</span>
  <span class="tareas-filter" aria-label="Filtrar tareas">
    <button type="button" class="filter-btn is-active" data-filter="all">Todas</button>
    <button type="button" class="filter-btn" data-filter="todo">Por hacer</button>
    <button type="button" class="filter-btn" data-filter="doing">En curso</button>
  </span>
</h2>

{% if tareas_asignadas %}
  <div class="tareas-grid" id="tareasGrid">
    {% for t in tareas_asignadas %}
      {# NUEVO: data-estado para filtrar #}
      <div class="tarea-card" data-estado="{{ t.estado }}">
        <div class="tarea-header">
          <div class="tarea-titulo">{{ t.titulo }}</div>

          <div class="tarea-actions">
            <button
              type="button"
              class="btn-detalle js-open-tarea"
              data-url="{% url 'proyectos:tarea_detalle_modal' t.id %}?context=perfil"
            >Detalle</button>

            {# --- BOT√ìN TOMAR (si hay >1 asignado y el usuario est√° asignado) --- #}
            {% if t.asignados.count > 1 and request.user in t.asignados.all %}
              <form method="post" action="{% url 'proyectos:tarea_tomar' t.id %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn-tomar">Tomar</button>
              </form>
            {% endif %}

            {# --- Bot√≥n de estado (Empezar/Terminada) --- #}
            {% if request.user in t.asignados.all %}
              {% if t.estado == 'todo' %}
                <button type="button"
                        class="btn-estado btn-start js-tarea-estado"
                        data-action="start"
                        data-url="{% url 'proyectos:tarea_cambiar_estado' t.id %}">
                  Empezar
                </button>
              {% elif t.estado == 'doing' %}
                <button type="button"
                        class="btn-estado btn-finish js-tarea-estado"
                        data-action="finish"
                        data-url="{% url 'proyectos:tarea_cambiar_estado' t.id %}">
                  Terminada
                </button>
              {% endif %}
            {% endif %}
          </div>
        </div>

        {% if t.proyecto %}
          <div class="tarea-proyecto">{{ t.proyecto.nombre }}</div>
        {% endif %}

        <div class="tarea-info">
          <div><span class="lbl">Vence:</span> {% if t.vence_el %}{{ t.vence_el|date:"d/m/Y" }}{% else %}‚Äî{% endif %}</div>
          <div><span class="lbl">Prioridad:</span> <span class="badge">{{ t.get_prioridad_display|default:"‚Äî" }}</span></div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# Modal de tarea #}
  <div class="modal-overlay" id="modalTarea" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTareaTitle">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTareaTitle">Detalle de tarea</h3>
        <button type="button" class="btn-close" id="closeModalTarea" aria-label="Cerrar">√ó</button>
      </div>
      <div class="modal-body">
        <div id="modalTareaContainer"><p style="margin:0;color:#666">Cargando‚Ä¶</p></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const overlay   = document.getElementById('modalTarea');
      const btnClose  = document.getElementById('closeModalTarea');
      const container = document.getElementById('modalTareaContainer');

      function open(){ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); }
      function close(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); }

      function attachChatHandlers(){
        const form = container.querySelector('#chatForm');
        const list = container.querySelector('#chatList');
        const box  = container.querySelector('#chatBox');
        if (!form) return;

        const scrollBottom = () => { if (box) box.scrollTop = box.scrollHeight; };
        scrollBottom();

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const data = new FormData(form);
          const btn  = form.querySelector('button[type=submit]');
          btn.disabled = true;
          try{
            const r = await fetch(form.action, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              body: data
            });
            const json = await r.json();
            if (json.ok){
              const tmp = document.createElement('div');
              tmp.innerHTML = json.html || '';
              let li = tmp.firstElementChild;
              if (!li) {
                li = document.createElement('li');
                li.className = 'msg me';
                li.innerHTML = '<div class="bubble"><div class="meta"><strong>Yo</strong> ¬∑ ahora</div><div class="text"></div></div>';
                li.querySelector('.text').textContent = data.get('mensaje') || '';
              }
              list.appendChild(li);
              form.reset();
              scrollBottom();
            } else {
              alert(json.error || 'No se pudo enviar el mensaje.');
            }
          } catch(err){
            console.error(err);
            alert('Error de red.');
          } finally {
            btn.disabled = false;
          }
        });
      }

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.js-open-tarea');
        if(!btn) return;

        container.innerHTML = '<p style="margin:0;color:#666">Cargando‚Ä¶</p>';
        open();
        const url = btn.dataset.url + (btn.dataset.url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => { container.innerHTML = html; attachChatHandlers(); })
          .catch(() => { container.innerHTML = '<p style="color:#a00">No se pudo cargar el detalle.</p>'; });
      });

      btnClose.addEventListener('click', close);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
    })();
  </script>
{% else %}
  <p>No ten√©s tareas asignadas.</p>
{% endif %}

{% now "Y" as current_year %}
<div class="horas-header">
  <h2 style="margin:0;">Mis horas</h2>

  <form method="get" class="horas-filter">
    <label>
      <span>Mes:</span>
      <input type="number"
             name="mes"
             min="1"
             max="12"
             value="{{ mes }}"
             style="width:70px;">
    </label>

    <label>
      <span>A√±o:</span>
      <input type="number"
            name="anio"
            min="2020"
            max="{{ anio_max }}"
            value="{{ anio_str }}"            
            style="width:90px;">
    </label>

    <button type="submit" class="btn-sm-horas">Filtrar</button>

    <span style="font-weight:600; margin-left:4px;">
      Total del mes: {{ total_mes|default:0|floatformat:2 }} h
    </span>
  </form>
</div>


{% if mis_horas_grouped %}
  <table class="perfil-horas">
    <thead>
      <tr>
        <th>Proyecto / √Årea</th>
        <th>√öltima fecha</th>
        <th>Total horas</th>
        <th>Reg.</th>
        <th>Detalles</th>
      </tr>
    </thead>
    <tbody>
      {% for g in mis_horas_grouped %}
        <tr>
          <td>{{ g.grupo_nombre }}</td>
          <td>{{ g.ultima|date:"d/m/Y"|default:"‚Äî" }}</td>
          <td>{{ g.total_horas }}</td>
          <td>{{ g.n_reg }}</td>
          <td>
            <button type="button"
                    class="btn-link js-ver-detalles"
                    data-pid="{{ g.pid }}">Ver</button>
          </td>
        </tr>

        <tr id="det-{{ g.pid }}" class="detalle-row" style="display:none">
          <td colspan="5">
            <table class="subtabla">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Horas</th>
                  <th>Proyecto/√Årea</th>
                  <th>Tarea</th>
                  <th>Estado</th>
                  <th>Descripci√≥n</th>
                </tr>
              </thead>
              <tbody>
              {% for h in mis_horas %}
                {% with pid=h.proyecto_id|default_if_none:0 %}
                  {% if pid == g.pid %}
                    <tr>
                      <td>{{ h.fecha|date:"d/m/Y" }}</td>
                      <td>{{ h.horas }}</td>
                      <td>{{ h.proyecto.nombre|default:"‚Äî" }}</td>
                      <td>{% if h.tarea %}{{ h.tarea.titulo }}{% else %}‚Äî{% endif %}</td>
                      <td>{{ h.get_estado_display }}</td>
                      <td>{{ h.descripcion|default:"" }}</td>
                    </tr>
                  {% endif %}
                {% endwith %}
              {% endfor %}
              </tbody>
            </table>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% elif mis_horas %}
  <table class="perfil-horas">
    <thead><tr><th>Fecha</th><th>Horas</th><th>Proyecto/Area</th><th>Tarea</th><th>Estado</th><th>Descripci√≥n</th></tr></thead>
    <tbody>
      {% for h in mis_horas %}
        <tr>
          <td>{{ h.fecha|date:"d/m/Y" }}</td>
          <td>{{ h.horas }}</td>
          <td>{{ h.proyecto.nombre|default:"‚Äî" }}</td>
          <td>{% if h.tarea %}{{ h.tarea.titulo }}{% else %}‚Äî{% endif %}</td>
          <td>{{ h.get_estado_display }}</td>
          <td>{{ h.descripcion|default:"" }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>A√∫n no cargaste horas.</p>
{% endif %}

{# ===================== Modal TRANSACCI√ìN ===================== #}
<div class="modal-overlay" id="modalTransaccion" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTransaccionTitle">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTransaccionTitle">
        {% if perms.proyectos.can_manage_economia or perms.economia.view_dashboard %}
          {% if perms.economia.can_add_ingresos or perms.economia.add_transaccion %}
            Nueva Transacci√≥n
          {% else %}
            Nuevo Gasto
          {% endif %}
        {% else %}
          Nuevo Gasto
        {% endif %}
      </h3>
      <button type="button" class="btn-close" id="closeModal" aria-label="Cerrar">√ó</button>
    </div>
    <div class="modal-body">
      <div id="modalFormContainer"><p style="margin:0;color:#666">Cargando formulario‚Ä¶</p></div>
    </div>
  </div>
</div>

{# ===================== Modal HORAS ===================== #}
<div class="modal-overlay" id="modalHoras" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalHorasTitle">
    <div class="modal-header">
      <h3 class="modal-title" id="modalHorasTitle">Cargar horas</h3>
      <button type="button" class="btn-close" id="closeModalHoras" aria-label="Cerrar">√ó</button>
    </div>
    <div class="modal-body">
      <div id="modalHorasContainer"><p style="margin:0;color:#666">Cargando formulario‚Ä¶</p></div>
    </div>
  </div>
</div>

<script>
/* Helper CSRF */
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

/* ===== NUEVO: Filtro de tareas (cliente) ===== */
(function(){
  const grid = document.getElementById('tareasGrid');
  const buttons = document.querySelectorAll('.tareas-filter .filter-btn');
  if(!grid || !buttons.length) return;

  function applyFilter(val){
    const cards = grid.querySelectorAll('.tarea-card');
    cards.forEach(card=>{
      const est = (card.getAttribute('data-estado') || '').trim();
      const show = (val === 'all') || (est === val);
      card.style.display = show ? '' : 'none';
    });
  }
  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      buttons.forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
      applyFilter(btn.dataset.filter);
    });
  });
})();

/* Toggle de detalles en "Mis horas" (agrupado) */
document.addEventListener('click', function(e){
  const btn = e.target.closest('.js-ver-detalles');
  if(!btn) return;
  const pid = btn.dataset.pid;
  const row = document.getElementById('det-' + pid);
  if(!row) return;
  const visible = row.style.display !== 'none';
  row.style.display = visible ? 'none' : 'table-row';
  btn.textContent = visible ? 'Ver' : 'Ocultar';
});

/* ===== Modal ‚ÄúNueva Transacci√≥n / Editar Transacci√≥n‚Äù ===== */
(function(){
  const overlay    = document.getElementById('modalTransaccion');
  const btnClose   = document.getElementById('closeModal');
  const container  = document.getElementById('modalFormContainer');
  const titleEl    = document.getElementById('modalTransaccionTitle');
  const defaultTitle = titleEl ? titleEl.textContent : 'Nueva Transacci√≥n';
  const URL_FORM   = "{% url 'economia:nuevo' %}";

  function openModalWith(url){
    if (!url) url = URL_FORM;

    // Si la URL ya trae ?..., conservamos y agregamos modal=1; si no, la agregamos
    if (!/modal=1/.test(url)) {
      url = url + (url.includes('?') ? '&' : '?') + 'modal=1';
    }

    // Cambiar t√≠tulo si detectamos edici√≥n (presencia de pk=)
    if (titleEl){
      if (/[\?&]pk=\d+/.test(url)) {
        titleEl.textContent = 'Editar transacci√≥n';
      } else {
        titleEl.textContent = defaultTitle;
      }
    }

    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden', 'false');
    container.innerHTML = '<p style="margin:0;color:#666">Cargando formulario‚Ä¶</p>';

    fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}, cache:'no-store'})
      .then(r => r.text())
      .then(html => { container.innerHTML = html; })
      .catch(() => { container.innerHTML = '<p style="color:#a00">No se pudo cargar el formulario.</p>'; });
  }

  function closeModal(){
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden','true');
    if (titleEl) titleEl.textContent = defaultTitle;
  }

  const btnOpen = document.getElementById('btnNuevaTransaccion');
  if (btnOpen) btnOpen.addEventListener('click', function(){ openModalWith(URL_FORM); });

  btnClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  // Delegaci√≥n para enlaces "Editar" que usan el mismo modal
  document.addEventListener('click', function(e){
    const a = e.target.closest('.js-open-modal');
    if (!a) return;
    e.preventDefault();
    const url = a.getAttribute('data-modal-url') || a.getAttribute('href');
    openModalWith(url);
  });
})();

/* ===== Modal ‚ÄúCargar horas‚Äù (AJAX) ===== */
(function(){
  const URL_HORAS = "{% url 'proyectos:horas_nueva' %}";
  const btnOpen = document.getElementById('btnCargarHoras');
  const overlay = document.getElementById('modalHoras');
  const btnClose = document.getElementById('closeModalHoras');
  const container = document.getElementById('modalHorasContainer');

  function openModal(){
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden', 'false');
    container.innerHTML = '<p style="margin:0;color:#666">Cargando formulario‚Ä¶</p>';
    fetch(URL_HORAS, {headers: {'X-Requested-With':'XMLHttpRequest'}, cache:'no-store'})
      .then(r => r.text())
      .then(html => { container.innerHTML = html; attachFormHandler(); })
      .catch(() => { container.innerHTML = '<p style="color:#a00">No se pudo cargar el formulario.</p>'; });
  }
  function closeModal(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); }

  function attachFormHandler(){
    const form = container.querySelector('#formHoras');
    const btnCancel = container.querySelector('#btnCancelarHoras');
    const btnHoy = container.querySelector('#btnHoy');

    if (btnCancel) btnCancel.addEventListener('click', closeModal);
    if (btnHoy) {
      btnHoy.addEventListener('click', function(){
        const hoyISO = new Date().toISOString().split('T')[0];
        const inputFecha = container.querySelector('#id_fecha');
        if (inputFecha) inputFecha.value = hoyISO;
      });
    }
    if (!form) return;

    function parseHM(v){
      const m = /^([01]\d|2[0-3]):([0-5]\d)$/.exec((v||'').trim());
      if (!m) return null;
      return parseInt(m[1],10)*60 + parseInt(m[2],10);
    }

    form.addEventListener('submit', async function(e){
      const inicioInp = container.querySelector('#id_inicio');
      const finInp    = container.querySelector('#id_fin');

      const minIni = parseHM(inicioInp && inicioInp.value);
      const minFin = parseHM(finInp && finInp.value);

      if (minIni === null || minFin === null){
        e.preventDefault();
        alert('Us√° formato 24 h HH:MM (ej.: 08:30).');
        return false;
      }
      if (!(minIni < minFin)){
        e.preventDefault();
        alert('La hora de inicio debe ser anterior a la hora de fin (mismo d√≠a).');
        return false;
      }

      // Enviar por AJAX robusto
      e.preventDefault();
      const formData = new FormData(form);
      const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';

      try{
        const r = await fetch(form.action, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrf
          },
          body: formData
        });

        const text = await r.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (data) {
          if (data.ok) {
            closeModal();
            alert('Horas registradas correctamente.');
            location.reload();
            return;
          }
          if (data.html) {
            container.innerHTML = data.html;
            attachFormHandler();
            return;
          }
          alert('Error al guardar.');
          return;
        }

        if (text.trim().startsWith('<')) {
          container.innerHTML = text;
          attachFormHandler();
          return;
        }

        alert('Ocurri√≥ un error inesperado al guardar.');
      } catch(err){
        console.error(err);
        alert('Error de red al guardar.');
      }
    });
  }

  if (btnOpen) btnOpen.addEventListener('click', openModal);
  btnClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
})();

/* Acciones Empezar/Terminada desde las cards (ya lo ten√≠as) */
document.addEventListener('click', async function(e){
  const btn = e.target.closest('.js-tarea-estado');
  if (!btn) return;

  const action = btn.getAttribute('data-action');
  const url    = btn.getAttribute('data-url');
  if (!action || !url) return;

  btn.disabled = true;
  try{
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
      },
      body: new URLSearchParams({ action })
    });
    const data = await r.json();

    if (!data.ok){
      alert(data.error || 'No se pudo actualizar el estado.');
      btn.disabled = false;
      return;
    }

    if (action === 'start'){
      btn.textContent = 'Terminada';
      btn.classList.remove('btn-start');
      btn.classList.add('btn-finish');
      btn.setAttribute('data-action', 'finish');
      btn.disabled = false;
    } else {
      const card = btn.closest('.tarea-card');
      if (card) card.remove();
    }
  }catch(err){
    console.error(err);
    alert('Error de red.');
    btn.disabled = false;
  }
});
</script>
{% endblock %}
