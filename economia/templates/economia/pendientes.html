{% extends "economia/_base_adminlike.html" %}
{# economia/pendientes.html #}
{% block title %}Transacciones pendientes{% endblock %}

{% block content_adminlike %}

<table>
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Usuario</th>
      <th>Descripción</th>
      <th>Importe</th>
      <th>Categoría (al aprobar)</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  {% for t in pendientes %}
    <tr>
      <td>{{ t.fecha|date:"d/m/Y" }}</td>
      <td>{{ t.usuario.username|default:"-" }}</td>
      <td>{{ t.descripcion }}</td>
      <td>${{ t.monto }}</td>
      <td>
        <form method="post" action="{% url 'economia:pendientes' %}" style="display:flex; gap:8px; align-items:center">
          {% csrf_token %}
          <input type="hidden" name="tx_id" value="{{ t.id }}">

          {# Selector de categoría (muestra INGRESOS y GASTOS) #}
          <select name="categoria_id" title="Categoría al aprobar">
            <option value="">— Elegí categoría —</option>

            <optgroup label="Ingresos">
              {% for c in categorias_ingreso %}
                <option value="{{ c.id }}"
                        {% if t.categoria_id == c.id %}selected{% endif %}>
                  {{ c.nombre }}
                </option>
              {% endfor %}
            </optgroup>

            <optgroup label="Gastos">
              {% for c in categorias_gasto %}
                <option value="{{ c.id }}"
                        {% if t.categoria_id == c.id %}selected{% endif %}>
                  {{ c.nombre }}
                </option>
              {% endfor %}
            </optgroup>
          </select>
      </td>
      <td style="white-space:nowrap">
          <button type="submit" name="accion" value="aprobar" class="btn-aprobar">Aprobar</button>

          {# Comentario para rechazo #}
          <input type="text" name="comentario" placeholder="Motivo del rechazo" style="width:220px;">
          <button type="submit" name="accion" value="rechazar" class="btn-rechazar">Rechazar</button>
        </form>
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="6">No hay pendientes.</td></tr>
  {% endfor %}
  </tbody>
</table>

<script>
  // Hace obligatorio el comentario SOLO cuando se presiona "Rechazar"
  document.querySelectorAll('form').forEach(function(f){
    const rechBtn = f.querySelector('.btn-rechazar');
    const com = f.querySelector('input[name="comentario"]');
    if (rechBtn && com) {
      rechBtn.addEventListener('click', function(){
        com.setAttribute('required', 'required');
      });
    }
    // Hace obligatorio elegir categoría SOLO cuando se presiona "Aprobar"
    const aprBtn = f.querySelector('.btn-aprobar');
    const sel = f.querySelector('select[name="categoria_id"]');
    if (aprBtn && sel) {
      aprBtn.addEventListener('click', function(){
        sel.setAttribute('required', 'required');
      });
    }
  });
</script>
{% endblock %}
