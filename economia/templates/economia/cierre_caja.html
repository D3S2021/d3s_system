{% extends "economia/_base_adminlike.html" %}
{% block title %}Cierre de caja{% endblock %}

{% block content_adminlike %}

<div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
  <h2 style="margin:0">Cierre de caja · {{ month }} / {{ year }}</h2>

  <div style="margin-left:auto;"></div>

  <button id="btnTarifasHoras"
          style="border:0;background:#1e40af;color:#fff;font-weight:700;border-radius:8px;padding:8px 14px;cursor:pointer;">
    PRECIO HORAS
  </button>
</div>

<style>
  /* === Grilla para 4 tarjetas === */
  .cards.cards-4{
    display:grid;
    grid-template-columns: repeat(4, minmax(220px,1fr));
    gap:14px;
    margin:10px 0 16px;
  }
  @media (max-width:1100px){ .cards.cards-4{ grid-template-columns: repeat(2,1fr); } }
  @media (max-width:560px){  .cards.cards-4{ grid-template-columns: 1fr; } }

  .cards .card{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:14px 16px;
  }
  .cards .k{ color:#64748b; font-size:12px; margin-bottom:6px; }
  .cards .number{ font-weight:800; font-size:22px; font-variant-numeric: tabular-nums; }
</style>

<div class="cards cards-4">
  <div class="card">
    <div class="k">Ingresos</div>
    <div class="number">${{ total_ingresos }}</div>
  </div>

  <div class="card">
    <div class="k">Gastos</div>
    <div class="number">${{ total_gastos }}</div>
  </div>

  <div class="card">
    <div class="k">Saldo CUENTA</div>
    <div class="number">${{ saldo_cuenta }}</div>
  </div>

  <div class="card">
    <div class="k">Saldo EFECTIVO</div>
    <div class="number">${{ saldo_efectivo }}</div>
  </div>
</div>

<form method="post" style="margin-top:16px">
  {% csrf_token %}
  <button name="accion" value="descargar_pdf" class="default" disabled title="Próximamente">Descargar resumen (PDF)</button>
</form>

<hr style="margin:18px 0" />

{# ====================== HORAS POR PERSONA Y PROYECTO ====================== #}
<style>
  .tabla-horas-cierre { width:100%; border-collapse:collapse; margin-top:8px; }
  .tabla-horas-cierre th, .tabla-horas-cierre td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; }
  .tabla-horas-cierre thead th { background:#fafafa; font-weight:600; }
  .fila-total-persona td { font-weight:600; background:#fcfcfc; }
  .subtle { color:#666; font-size:12px; }
  .person-header { display:flex; align-items:baseline; gap:8px; margin:14px 0 6px; }

  /* Botón "Ver" estilo link (igual que perfil) */
  .btn-link { border:none; background:transparent; color:#2c7be5; cursor:pointer; font-weight:600; padding:0; }
  .btn-link:hover { text-decoration:underline; }

  /* Subfila (detalle) */
  .detalle-row td{ background:#fbfdff; }
  .subtabla{ width:100%; border-collapse:collapse; }
  .subtabla th, .subtabla td{ padding:8px; border-bottom:1px solid #eef2f7; text-align:left; }
  .subtabla th{ background:#f8fafc; color:#334155; }
</style>

<div class="resumen-horas" style="display:flex; align-items:center; justify-content:space-between; margin:6px 0 4px;">
  <h3 style="margin:0">Horas por persona y proyecto</h3>
  <div class="subtle">Periodo: <strong>{{ month }}/{{ year }}</strong> — (solo <em>aprobadas</em>)</div>
</div>

{% if horas_por_persona %}
  {% for p in horas_por_persona %}
    <div class="person-header">
      <h4 style="margin:0">{{ p.persona }}</h4>
      <span class="subtle">@{{ p.username }}</span>
    </div>

    <table class="tabla-horas-cierre">
      <thead>
        <tr>
          <th style="width:60%">Proyecto/Area</th>
          <th style="width:20%">Horas</th>
          <th style="width:20%">Registros</th>
        </tr>
      </thead>
      <tbody>
        {% for it in p.proyectos %}
          {# Fila principal #}
          <tr data-row="principal">
            <td>
              {% if it.proyecto_id %}
                <a href="{% url 'proyectos:detalle' it.proyecto_id %}">{{ it.proyecto }}</a>
              {% else %}
                {{ it.proyecto|default:"—" }}
              {% endif %}
            </td>
            <td>{{ it.horas|floatformat:2 }}</td>
            <td>
              <button type="button"
                      class="btn-link js-ver-reg"
                      data-user="{{ p.username }}"
                      data-persona="{{ p.persona }}"
                      data-proyecto="{{ it.proyecto_id|default:0 }}"
                      data-proyecto-nombre="{{ it.proyecto|default:'—' }}">
                Ver
              </button>
            </td>
          </tr>
          {# Fila detalle (se llena por AJAX) #}
          <tr class="detalle-row" id="det-{{ p.username }}-{{ it.proyecto_id|default:0 }}" style="display:none">
            <td colspan="3"><div class="detalle-box">Cargando…</div></td>
          </tr>
        {% endfor %}
        <tr class="fila-total-persona">
          <td>Total {{ p.persona }}</td>
          <td>{{ p.total_persona|floatformat:2 }}</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  {% endfor %}

  <div style="text-align:right; margin-top:10px;">
    <strong>Total general de horas ({{ month }}/{{ year }}): {{ total_horas_general|floatformat:2 }}</strong>
  </div>
{% else %}
  <p style="margin:10px 0">No hay horas aprobadas para el período seleccionado.</p>
{% endif %}

{# ====================== MODAL PRECIO HORAS (sin cambios) ====================== #}
<div id="tarifasModalOverlay" class="tm-overlay" aria-hidden="true" style="display:none">
  <div class="tm-modal" role="dialog" aria-modal="true" aria-labelledby="tmTitle">
    <div class="tm-header">
      <h3 id="tmTitle" style="margin:0">Tarifa por hora (usuarios)</h3>
      <button type="button" class="tm-close" aria-label="Cerrar">×</button>
    </div>
    <div class="tm-body" id="tmBody">Cargando…</div>
    <div class="tm-footer">
      <button type="button" class="tm-btn" id="tmCancel">Cancelar</button>
      <button type="button" class="tm-btn tm-primary" id="tmSave">Guardar</button>
    </div>
  </div>
</div>

<style>
  .tm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1200;display:flex;align-items:center;justify-content:center;padding:24px}
  .tm-modal{background:#fff;border-radius:12px;box-shadow:0 10px 35px rgba(0,0,0,.25);width:min(860px,92vw);display:flex;flex-direction:column;overflow:hidden}
  .tm-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee}
  .tm-body{padding:10px 14px;max-height:68vh;overflow:auto}
  .tm-footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eee}
  .tm-close{border:0;background:transparent;font-size:22px;cursor:pointer}
  .tm-btn{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:8px 14px;cursor:pointer}
  .tm-primary{background:#1e40af;color:#fff;border-color:#1e40af}
  .tm-table{width:100%;border-collapse:collapse}
  .tm-table th,.tm-table td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  .tm-num{width:140px;text-align:right}
</style>

<script>
/* ===== Modal de tarifas (igual que tenías) ===== */
(function(){
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():'';
  }
  const btn = document.getElementById('btnTarifasHoras');
  const ov  = document.getElementById('tarifasModalOverlay');
  const body= document.getElementById('tmBody');
  const bClose = ov.querySelector('.tm-close');
  const bCancel= document.getElementById('tmCancel');
  const bSave  = document.getElementById('tmSave');

  function openModal(){
    body.textContent = 'Cargando…';
    ov.style.display = 'flex';
    fetch("{% url 'economia:tarifas_modal' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}, cache:'no-store'})
      .then(r=>r.text()).then(html=> body.innerHTML = html)
      .catch(()=> body.innerHTML = '<p style="color:#a00">Error al cargar.</p>');
    document.documentElement.style.overflow='hidden';
    document.body.style.overflow='hidden';
  }
  function closeModal(){
    ov.style.display = 'none';
    document.documentElement.style.overflow='';
    document.body.style.overflow='';
  }

  btn?.addEventListener('click', openModal);
  bClose?.addEventListener('click', closeModal);
  bCancel?.addEventListener('click', closeModal);
  ov?.addEventListener('click', (e)=>{ if(e.target===ov) closeModal(); });

  bSave?.addEventListener('click', async function(){
    const form = body.querySelector('#formTarifasHoras');
    if(!form) return;
    const fd = new FormData(form);
    try{
      const r = await fetch("{% url 'economia:tarifas_guardar' %}", {
        method:'POST',
        credentials:'same-origin',
        headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')},
        body: fd
      });
      const data = await r.json();
      if(!r.ok || !data.ok) throw 0;
      closeModal();
      alert(`Listo: ${data.saved} tarifa(s) guardada(s).`);
    }catch(_){
      alert('No se pudo guardar. Revisá los valores.');
    }
  });
})();

/* ===== Subtabla de registros (SIN filtro de período) ===== */
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-ver-reg');
    if(!btn) return;

    const user = (btn.dataset.user || '').trim();
    const pid  = (btn.dataset.proyecto || '0').trim();
    const rowId = `det-${user}-${pid}`;
    const detRow = document.getElementById(rowId);

    // Toggle si ya está abierta
    if(detRow && detRow.style.display !== 'none'){
      detRow.style.display = 'none';
      btn.textContent = 'Ver';
      return;
    }

    // Asegurar existencias
    if(!detRow) return;

    // Loading…
    detRow.style.display = 'table-row';
    btn.textContent = 'Ocultar';
    const box = detRow.querySelector('.detalle-box');
    if (box) box.textContent = 'Cargando…';

    // OJO: NO enviamos month/year -> queremos TODAS las horas
    const params = new URLSearchParams({ user: user, proyecto_id: pid });

    fetch("{% url 'economia:horas_registros_modal' %}?" + params.toString(),
          { headers:{'X-Requested-With':'XMLHttpRequest'}, cache:'no-store' })
      .then(r => r.text())
      .then(html => {
        if (box) box.innerHTML = html;
      })
      .catch(() => {
        if (box) box.innerHTML = '<p style="color:#a00;margin:0">No se pudieron cargar los registros.</p>';
      });
  });
})();
</script>

{% endblock %}
