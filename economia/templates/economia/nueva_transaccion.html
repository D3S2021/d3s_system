{% load static l10n %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>
    {% if modo_edicion %}
      Editar Transacción
    {% else %}
      {% if perms.economia.can_add_ingresos %}Nueva Transacción{% else %}Nuevo Gasto{% endif %}
    {% endif %}
  </title>
  <!-- estilos del admin -->
  <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
</head>

<body class="app-economia change-form">
  <div id="container">

    <div id="header">
      <div id="branding">
        <h1 id="site-name">Sistema D3S</h1>
      </div>
      <div id="user-tools">
        Bienvenido, {{ user.get_full_name|default:user.username }} ·
        <a href="{% url 'logout' %}">Cerrar sesión</a>
      </div>
    </div>

    <div id="content" class="colM">
      <h1>
        {% if modo_edicion %}
          Editar Transacción
        {% else %}
          {% if perms.economia.can_add_ingresos %}Nueva Transacción{% else %}Nuevo Gasto{% endif %}
        {% endif %}
      </h1>

      <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <fieldset class="module aligned">

          <!-- CATEGORÍA (solo usuarios con permiso y solo si el form la trae) -->
          {% if perms.economia.can_add_ingresos and form.categoria %}
          <div class="form-row field-categoria">
            <div>
              <label for="{{ form.categoria.id_for_label }}">Categoría:</label>
              {{ form.categoria.errors }}
              {{ form.categoria }}
            </div>
          </div>
          {% endif %}

          <!-- FECHA + HOY -->
          <div class="form-row field-fecha">
            <div>
              <label for="{{ form.fecha.id_for_label }}">Fecha:</label>
              {{ form.fecha.errors }}
              {{ form.fecha }}
              <a href="#" id="btnHoy" style="margin-left:8px;">Hoy</a>
              <script>
                (function(){
                  var fecha = document.getElementById('{{ form.fecha.id_for_label }}');
                  if (fecha && !fecha.value && "{{ tx.fecha|date:'Y-m-d' }}") {
                    fecha.value = "{{ tx.fecha|date:'Y-m-d' }}";
                  }
                })();
              </script>
            </div>
          </div>


          <!-- MONTO (formateado ARS + hidden normalizado) -->
          <style>
            .money-wrap{display:flex;align-items:center;gap:6px}
            .money-wrap .peso{font-weight:bold}
          </style>

          <div class="form-row field-monto">
            <div>
              <label for="monto_display">Monto (ARS):</label>
              <input type="text"
                    id="monto_display"
                    class="vTextField"
                    inputmode="decimal"
                    autocomplete="off"
                    required
                    placeholder="$ 0,00"
                    value="{% if tx %}{{ tx.monto|unlocalize }}{% else %}{{ form.monto.value|default:'' }}{% endif %}">
              <!-- ESTE es el que manda a Django -->
              <input type="hidden" id="id_monto" name="monto"
                    value="{% if tx %}{{ tx.monto|unlocalize }}{% else %}{{ form.monto.value|default:'' }}{% endif %}">
              <small>Ej.: $ 1.234,56</small>
            </div>
          </div>


          <!-- DESCRIPCIÓN -->
          <div class="form-row field-descripcion">
            <div>
              <label for="{{ form.descripcion.id_for_label }}">Descripción:</label>
              {{ form.descripcion.errors }}
              {{ form.descripcion }}
              <!-- Más adelante acá agregamos “Proyecto/Tipo de trabajo” -->
            </div>
          </div>

        </fieldset>

        <div class="submit-row">
          <button type="submit" class="default">
            {% if modo_edicion %}Guardar cambios{% else %}Guardar{% endif %}
          </button>
          <a class="button cancel-link" href="{% url 'perfil' %}" style="margin-left:10px;">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Botón "Hoy" para setear la fecha actual
    (function () {
      const btn = document.getElementById('btnHoy');
      if (!btn) return;
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const input = document.getElementById('{{ form.fecha.id_for_label }}');
        if (input) {
          const d = new Date();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          input.value = `${d.getFullYear()}-${mm}-${dd}`; // yyyy-mm-dd
        }
      });
    })();
  </script>

  <script>
  (function(){
    function toNormalized(val){
      if (!val) return "";
      let s = (""+val).trim();
      s = s.replace(/\s/g,"").replace(/\$/g,"").replace(/[A-Za-z]/g,"");
      if (s.includes(",") && s.includes(".")) {
        s = s.replace(/\./g,"").replace(/,/g,".");
      } else if (s.includes(",")) {
        s = s.replace(/,/g,".");
      }
      s = s.replace(/[^0-9.]/g,"");
      const parts = s.split(".");
      if (parts.length > 2) s = parts.shift() + "." + parts.join("");
      return s;
    }

    function formatARS(n){
      const num = Number(n);
      if (isNaN(num)) return "";
      return new Intl.NumberFormat("es-AR", { style:"currency", currency:"ARS" }).format(num);
    }

    const disp = document.getElementById("monto_display");
    const hid  = document.getElementById("id_monto");
    if (!disp || !hid) return;

    if (hid.value) disp.value = formatARS(hid.value);

    disp.addEventListener("input", function(){
      hid.value = toNormalized(disp.value);
    });

    disp.addEventListener("blur", function(){
      if (hid.value) disp.value = formatARS(hid.value);
    });

    disp.addEventListener("focus", function(){
      disp.value = hid.value || "";
    });

    const form = disp.closest("form");
    if (form) {
      form.addEventListener("submit", function(){
        hid.value = toNormalized(disp.value);
      });
    }
  })();
  </script>

<script>
(function(){
  function toNormalized(val){
    if (!val) return "";
    let s = (""+val).trim();
    s = s.replace(/\s/g,"").replace(/\$/g,"").replace(/[A-Za-z]/g,"");
    if (s.includes(",") && s.includes(".")) { s = s.replace(/\./g,"").replace(/,/g,"."); }
    else if (s.includes(",")) { s = s.replace(/,/g,"."); }
    s = s.replace(/[^0-9.]/g,"");
    const parts = s.split(".");
    if (parts.length > 2) s = parts.shift() + "." + parts.join("");
    return s;
  }

  function formatARS(n){
    const num = Number(n);
    if (isNaN(num)) return "";
    return new Intl.NumberFormat("es-AR", {style:"currency", currency:"ARS"}).format(num);
  }

  const disp = document.getElementById("monto_display");  // campo visible
  const hid  = document.getElementById("id_monto");       // hidden
  if (!disp || !hid) return;

  // 1) Al entrar a la página, si ya hay valor → mostrarlo formateado
  if (disp.value) {
    hid.value = toNormalized(disp.value);
    disp.value = formatARS(hid.value);
  } else if (hid.value) {
    disp.value = formatARS(hid.value);
  }

  // 2) Cuando el usuario escribe → actualizar hidden
  disp.addEventListener("input", function(){
    hid.value = toNormalized(disp.value);
  });

  // 3) Cuando el usuario termina de escribir (blur) → formatear visible
  disp.addEventListener("blur", function(){
    if (hid.value) disp.value = formatARS(hid.value);
  });

  // 4) Antes de enviar → normalizar hidden por seguridad
  const form = disp.closest("form");
  if (form) {
    form.addEventListener("submit", function(){
      hid.value = toNormalized(disp.value);
    });
  }
})();
</script>


</body>
</html>
